<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Events Widget</title>

  <!-- MapLibre 3.6.2 (UMD) -->
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

  <style>
    :root{
      --bg: #0b0b0b;           /* widget background */
      --panel: #121212;        /* pinned panel background */
      --text: #f3f3f3;         /* primary text */
      --muted: #a1a1aa;        /* secondary text */
      --accent: #0ea5e9;       /* accents & focus */
      --marker: #888;          /* default marker */
      --marker-promoted: #ff2d9b; /* hot pink */
      --ring: #fff;            /* white ring for map markers */
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}

    /* --- Layout: Map (left) + Pinned panel (right) --- */
    .widget{
      display:grid; grid-template-columns: 1fr min(380px, 40%);
      gap: 10px; height: min(80vh, 760px); padding:10px;
    }
    #map{ width:100%; height:100%; border-radius: var(--radius); overflow:hidden; }

    .panel{
      background: var(--panel);
      border-radius: var(--radius);
      padding: 12px; display:flex; flex-direction:column; gap:12px;
      min-height:0; /* allow child scroll */
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .header{ display:flex; gap:8px; align-items:center; justify-content:space-between; }

    .dateFilter{
      appearance:none; background:#1c1c1c; color:var(--text);
      border:1px solid #2a2a2a; border-radius:10px; padding:8px 10px;
      outline:none; box-shadow:none; font:inherit; width: 100%;
    }

    .legend{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--marker); box-shadow:0 0 0 2px var(--ring) inset; }
    .dot.promo{ background:var(--marker-promoted); }

    .card{ background:#1a1a1a; border:1px solid #2a2a2a; border-radius:12px; overflow:hidden; }
    .card .media{ aspect-ratio: 16/9; background:#0d0d0d; display:block; width:100%; object-fit:cover; }
    .card .body{ padding:12px; }
    .title{ font-weight:700; font-size:16px; margin:0 0 2px; }
    .muted{ color:var(--muted); font-size:12px; }
    .desc{ margin-top:8px; color:#e7e7e7; font-size:13px; }
    .descMore{ cursor:pointer; color:var(--muted); }
    .descMore:hover{ text-decoration: underline; }



    
    .btns{ display:flex; gap:8px; margin-top:10px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #2c2c2c; background:#181818; color:#fff; text-decoration:none;
      padding:8px 10px; border-radius:10px; cursor:pointer; user-select:none;
      transition: transform .06s ease, border-color .2s;
    }
    .btn:hover{ border-color:#3a3a3a; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#03121a; font-weight:700; }

    /* --- Map marker styles (div markers) --- */
    .eventMarker{
      --marker-color: var(--marker);
      width:12px; height:12px; border-radius:999px; background: var(--marker-color);
      position:absolute; box-shadow: 0 0 0 2px var(--ring), 0 2px 8px rgba(0,0,0,.2);
      transform: translate(-50%, -50%);
    }
    .eventMarker--promoted{ --marker-color: var(--marker-promoted); width:10px; height:10px; box-shadow: 0 0 0 3px var(--ring), 0 2px 10px rgba(0,0,0,.35); filter: drop-shadow(0 0 10px var(--marker-promoted)); }
    /* Centered number (optional) */
    .eventMarker__num{ position:absolute; inset:0; display:grid; place-items:center; color:#000; font-weight:800; font-size:11px; text-shadow:0 1px 0 rgba(255,255,255,.6); }
    .eventMarker--static{ --marker-color: #14b8a6; } /* teal */



    
    /* Small screens: stack panel under map */
    @media (max-width: 820px){
      .widget{ grid-template-columns: 1fr; height: auto; }
      #map{ height: 54vh; }
    }
    /* Optional: make the pretty date button look a bit more input-like */
#datePretty { font-weight:600; }

  </style>
</head>
<body>
  <div class="widget" id="widgetRoot">
    <div id="map"></div>

    <aside class="panel">
      <div class="header">
        <div>
          <div style="font-weight:700">Local Events</div>
          <div class="legend"><span class="dot"></span> Nearby <span class="dot promo"></span> Promoted</div>
        </div>
      </div>

      <div class="row">
  <button id="datePretty" class="btn" type="button" style="gap:6px;"></button>

  <!-- Real date input (we’ll reposition it in JS when needed) -->
  <input id="dateFilter" class="dateFilter" type="date"
         style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;"
         aria-hidden="true" />
</div>


      <!-- Pinned event card -->
      <div class="card" id="pinned">
        <img id="pinPhoto" class="media" alt="Event photo" />
        <div class="body">
          <h3 id="pinTitle" class="title">Select a marker</h3>
          <div id="pinMeta" class="muted">Pick a date (optional) and click a marker on the map.</div>
          <div id="pinDesc" class="desc" style="display:none"></div>
          <div class="btns">
            <a id="pinMore" class="btn" href="#" target="_blank" rel="noopener" style="display:none">More Info</a>
            <a id="pinMenu" class="btn" href="#" target="_blank" rel="noopener" style="display:none">Menu</a>

            
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
  /*****************************************************************
   * EMBED-READY WIDGET (single file)
   *
   * Configure via the CONFIG object below OR via query params:
   *   ?sheet=SPREADSHEET_ID&tab=Sheet1&style=STYLE_URL&pm=PMTILES_URL
   *   &hotelName=Soho%20Hotel%20Toronto&hotelLat=43.64&hotelLng=-79.39
   *****************************************************************/
 if (!window.maplibregl) {
      const el = document.getElementById('map');
      el.style.display = 'grid';
      el.style.placeItems = 'center';
      el.style.color = '#bbb';
      el.innerHTML = 'Map library failed to load. Try self-hosting or check CDN blockers.';
      throw new Error('MapLibre not loaded');
    }

    
  const CONFIG = {
    SHEET_ID: "11ypk6inWH_ssq1giGnHOhOJg8_sVjlzExoKoWWXt_RU",     // Google Sheet ID (viewable/Published to web)
    SHEET_TAB: "Events",                   // Sheet/tab name
    STYLE_URL: "https://todoto.ca/style.json",  // Your MapLibre style.json (can reference pmtiles)
    PMTILES_URL: "",                       // Optional: pmtiles URL if your style references pmtiles:// URLs
    HOTEL_ORIGIN: {                         // Origin for directions
      name: "SoHo Hotel Toronto",
      lat: 43.64472457308373,  // e.g., 43.64274
      lng: -79.3922206565273   // e.g., -79.39478
    },
    MAP: {
      center: [-79.3922206565273, 43.64472457308373], // [lng, lat] – Queen's Park default
      zoomDesktop: 12.8,
      zoomMobile: 11.6,
      pitch: 0,
      bearing: -15 // subtle clockwise rotation
    }
  };

  // Allow overrides by query params for easy per-hotel embeds
  const qp = new URLSearchParams(location.search);
  if (qp.get('sheet')) CONFIG.SHEET_ID = qp.get('sheet');
  if (qp.get('tab')) CONFIG.SHEET_TAB = qp.get('tab');
  if (qp.get('style')) CONFIG.STYLE_URL = qp.get('style');
  if (qp.get('pm')) CONFIG.PMTILES_URL = qp.get('pm');
  if (qp.get('hotelName')) CONFIG.HOTEL_ORIGIN.name = qp.get('hotelName');
  if (qp.get('hotelLat')) CONFIG.HOTEL_ORIGIN.lat  = parseFloat(qp.get('hotelLat'));
  if (qp.get('hotelLng')) CONFIG.HOTEL_ORIGIN.lng  = parseFloat(qp.get('hotelLng'));


// Debug: confirm MapLibre loaded and supports custom protocols
console.log('MapLibre version:', maplibregl && maplibregl.version);
console.log('addProtocol exists?', !!(maplibregl && maplibregl.addProtocol));
    
  // Always register pmtiles:// protocol so styles can reference pmtiles:// URLs
  const protocol = new pmtiles.Protocol();    
  maplibregl.addProtocol("pmtiles", protocol.tile);
  // Preload for faster first paint (optional)
  if (CONFIG.PMTILES_URL){
    const p = new pmtiles.PMTiles(CONFIG.PMTILES_URL);
    protocol.add(CONFIG.PMTILES_URL, p);
  }


    // build map 
// build map
// build map (start view so there's no flash)
const isMobile  = matchMedia('(max-width: 820px)').matches;
const finalZoom = isMobile ? CONFIG.MAP.zoomMobile : CONFIG.MAP.zoomDesktop;
const startZoom = Math.max(3, finalZoom - 0.8);

const map = new maplibregl.Map({
  container: 'map',
  style: CONFIG.STYLE_URL,
  center: CONFIG.MAP.center,
  zoom: startZoom,   // start slightly zoomed out
  pitch: 0,          // flat at start
  bearing: 0,        // no rotation at start
  attributionControl: true,
  hash: false
});

let introAnimating = false;
const doAnim =
  !window.matchMedia('(prefers-reduced-motion: reduce)').matches &&
  !qp.get('noAnim');

map.once('load', () => {
  if (doAnim) {
    introAnimating = true;
    map.easeTo({
      center:  CONFIG.MAP.center,
      zoom:    finalZoom,
      bearing: CONFIG.MAP.bearing, // use +15 for clockwise
      pitch:   CONFIG.MAP.pitch,
      duration: 1400,
      easing: t => 1 - Math.pow(1 - t, 3)
    });
    map.once('moveend', () => { introAnimating = false; });
  } else {
    map.jumpTo({
      center:  CONFIG.MAP.center,
      zoom:    finalZoom,
      bearing: CONFIG.MAP.bearing,
      pitch:   CONFIG.MAP.pitch
    });
  }
});



    
  // Remove maplibre logo (if desired, keep attribution per license)
  map.addControl(new maplibregl.NavigationControl({showCompass:false, showZoom:false}), 'bottom-right'); // Zoom buttons hidden

  // Data state
  let allEvents = [];
  const markers = [];

  // Elements
  const pinCard  = document.getElementById('pinned');
  const pinPhoto = document.getElementById('pinPhoto');
  const pinTitle = document.getElementById('pinTitle');
  const pinMeta  = document.getElementById('pinMeta');
  const pinDesc  = document.getElementById('pinDesc');
  const pinMore  = document.getElementById('pinMore');
  const dateFilter = document.getElementById('dateFilter');
const datePretty = document.getElementById('datePretty');


function updateDatePretty(){
  const v = dateFilter.value;
  if (!v){ datePretty.textContent = 'Select date'; return; }
  const d = new Date(v + 'T00:00:00');
  datePretty.textContent = d.toLocaleDateString(undefined, {
    weekday:'short', month:'short', day:'numeric', year:'numeric'
  });
}
updateDatePretty();

// Open native picker when button is clicked (works across browsers)
datePretty.addEventListener('click', () => {
  openNativeDatePicker(dateFilter, datePretty);
});

// Keep label + map in sync on change
dateFilter.addEventListener('change', () => { updateDatePretty(); render(); });

// Optional: keyboard accessibility on the button
datePretty.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openNativeDatePicker(dateFilter, datePretty); }
});


    // --- Default date selector to today ---
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
dateFilter.value = `${yyyy}-${mm}-${dd}`;

  // Sheet -> JSON loader (Google Visualization API, public readable)
  async function loadSheet(){
    if(!CONFIG.SHEET_ID) throw new Error('Missing CONFIG.SHEET_ID');
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(CONFIG.SHEET_TAB)}`;
    const res = await fetch(url, {cache:'no-store'});
    const text = await res.text();
    const json = JSON.parse(
  text
    .replace(/^[\s\S]*setResponse\(/, '') // strip everything up to setResponse(
    .replace(/\);\s*$/, '')                // strip the trailing );
);

    return gvizToObjects(json);
  }

  // Convert Google Visualization JSON to array of objects with normalized keys
  function gvizToObjects(gv){
    const cols = gv.table.cols.map(c => (c.label || c.id || '').trim());
    const rows = gv.table.rows.map(r => r.c.map(c => c ? c.v : null));
    return rows.map(arr => Object.fromEntries(cols.map((k,i)=>[k, arr[i]])));
  }

  // Basic normalizer for expected schema
function normalize(ev){
  const get = (k, fallback='') => (ev[k] ?? ev[k?.toLowerCase?.()] ?? fallback);
  const num = (n) => (n==null || n==="" ? null : Number(n));

  const name  = String(get('Event name') || get('Name') || get('Title') || 'Event').trim();
  const date  = (get('Date') || '').toString().slice(0,10); // yyyy-mm-dd
  const start = (get('Start') || get('Time') || '').toString();
  const end   = (get('End') || '').toString();
  const cat   = String(get('Category') || 'Other').trim();
  const link  = String(get('Link') || get('URL') || '').trim();
  const addr  = String(get('Address') || '').trim();
  const photo = String(get('Photo') || '').trim();

  // Robust description: accept several possible headers
  const descRaw =
      get('Description')
   || get('Desc')
   || get('About')
   || get('Details')
   || get('Summary')
   || get('Notes')
   || '';
  const desc  = String(descRaw ?? '').trim();

  const openH = String(get('Open') || get('Open Hours') || '').trim();
  const closeH= String(get('Close') || get('Close Hours') || '').trim();
  const lat   = num(get('Lat'));
  const lng   = num(get('Lng'));
  const menu  = String(get('Menu') || get('Menu URL') || '').trim();

  const promoted = /^(1|true|yes|y)$/i.test(String(get('Promoted')||'').trim());
  const isStatic = !date; // no Date = static venue (always show)

  // Normalize category to the main 5 buckets
  const catLC = cat.toLowerCase();
  let category = 'Other';
  if (/^restaurant/.test(catLC)) category = 'Restaurants';
  else if (/^venue/.test(catLC)) category = 'Venues';
  else if (/^activit/.test(catLC)) category = 'Activities';
  else if (/^shop/.test(catLC)) category = 'Shopping';
  else if (/^event/.test(catLC)) category = 'Events';
  else if (cat) category = cat;

  return { name, date, start, end, category, link, address:addr, photo, desc, openH, closeH, lat, lng, promoted, isStatic, menu };
}


function openNativeDatePicker(dateInput, anchorEl){
  // Measure the pretty button and overlay the real input there
  const r = anchorEl.getBoundingClientRect();
  const s = dateInput.style;
  s.position   = 'fixed';
  s.left       = r.left + 'px';
  s.top        = r.top  + 'px';
  s.width      = r.width + 'px';
  s.height     = r.height + 'px';
  s.opacity    = 0;
  s.pointerEvents = 'auto';
  s.zIndex     = 9999;

  const cleanup = () => {
    // move offscreen again
    s.position = 'absolute';
    s.left = '-9999px';
    s.top  = '0';
    s.width = '1px';
    s.height= '1px';
    s.zIndex = '';
    s.pointerEvents = 'none';
  };

  const onDone = () => { cleanup(); dateInput.removeEventListener('blur', onDone); dateInput.removeEventListener('change', onDone); };

  dateInput.addEventListener('blur', onDone);
  dateInput.addEventListener('change', onDone);

  // Focus and try to open the picker
  dateInput.focus({preventScroll:true});
  // Prefer showPicker if supported (Chromium); fall back to click()
  if (typeof dateInput.showPicker === 'function') {
    try { dateInput.showPicker(); } catch {}
  } else {
    // Safari/Firefox – programmatic click usually works when focused & visible
    dateInput.click();
  }
}


  // Utility: Google Maps directions URL
  function gmapsDirUrl(origin, dest, mode='walking'){
    const params = new URLSearchParams({ api: '1', origin, destination: dest, travelmode: mode });
    return `https://www.google.com/maps/dir/?${params.toString()}`;
  }

  function fmtTimeRange(start, end){
    const s = start ? start : '';
    const e = end ? ` – ${end}` : '';
    return (s||e) ? `${s}${e}` : '';
  }

  // Render markers for current filter
  function render(){
    // clear old markers
    markers.splice(0).forEach(m => m.remove());

    const chosenDate = dateFilter.value ? dateFilter.value : '';
    const filtered = allEvents.filter(e => {
  if (!chosenDate) return true;   // no filter → show all
  if (!e.date) return true;       // static (no date) → always show
  return e.date === chosenDate;   // dated events must match
});


    // Promoted first for z-index layering
    const ordered = [
      ...filtered.filter(e => e.promoted),
      ...filtered.filter(e => !e.promoted)
    ];

    ordered.forEach((ev, idx) => {
      if(ev.lat==null || ev.lng==null) return; // skip if no coords

      const el = document.createElement('div');
el.className = 'eventMarker' + (
  ev.promoted ? ' eventMarker--promoted' :
  (!ev.date ? ' eventMarker--static' : '')
);


      const marker = new maplibregl.Marker({element: el, anchor:'center'})
        .setLngLat([ev.lng, ev.lat])
        .addTo(map);
      markers.push(marker);

      el.addEventListener('click', () => selectEvent(ev));
    });
  }
    

function normalizeLink(u) {
  if (!u) return '';
  const s = String(u).trim();

  // already absolute
  if (/^https?:\/\//i.test(s)) return s;

  // protocol-relative //example.com
  if (/^\/\//.test(s)) return 'https:' + s;

  // bare www.example.com or example.com/path
  if (/^[\w.-]+\.[a-z]{2,}(\/.*)?$/i.test(s)) return 'https://' + s;

  // mailto:, tel:, etc. (leave as-is)
  return s;
}

function sanitizeDesc(html){
  if (!html) return '';

  // Convert raw URLs to links first (basic)
  html = html.replace(/(^|\s)((https?:\/\/)?[\w.-]+\.[a-z]{2,}(\/\S*)?)/ig, (m, pre, url) => {
    const hasScheme = /^https?:\/\//i.test(url);
    const href = hasScheme ? url : 'https://' + url;
    return `${pre}<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });

  // Replace newlines with <br>
  html = html.replace(/\n/g, '<br>');

  // Very light sanitize: keep only a small set of tags
  const allowed = /<(\/)?(br|b|strong|i|em|a)(\s+[^>]*)?>/gi;

  return html
    .replace(/</g, '&lt;')
    .replace(/&lt;(\/)?(br|b|strong|i|em|a)(\s+[^>]*)?&gt;/gi, (m) => {
      // re-enable allowed tags
      return m
        .replace('&lt;', '<')
        .replace('&gt;', '>');
    });
}

function renderTruncatedDesc(raw, el, limit = 500){
  const plain = String(raw || '');
  const cleanFull = sanitizeDesc(plain);

  if (plain.length <= limit){
    el.innerHTML = cleanFull;
    el.style.display = cleanFull ? 'block' : 'none';
    return;
  }

  // Make a truncated preview; avoid cutting mid-word for nicer look
  const cutAt = (() => {
    const soft = plain.slice(0, limit);
    const lastSpace = soft.lastIndexOf(' ');
    return lastSpace > 400 ? lastSpace : limit; // try to end near a word boundary
  })();

  const preview = sanitizeDesc(plain.slice(0, cutAt).trim());
  el.innerHTML = `${preview}<span class="descMore" aria-label="Show more">…</span>`;
  el.style.display = 'block';

  // One-time expand on click of the ellipsis
  const more = el.querySelector('.descMore');
  if (more){
    more.addEventListener('click', () => {
      el.innerHTML = cleanFull;
    }, { once: true });
  }
}

    
function selectEvent(ev){
  // Photo
  pinPhoto.src = ev.photo || '';
  pinPhoto.style.display = ev.photo ? 'block' : 'none';

  // Title
  pinTitle.textContent = ev.name || 'Event';

  // When / Where (hide row if empty)
  const dateStr = ev.date
    ? new Date(ev.date + 'T00:00:00').toLocaleDateString(undefined, {
        weekday:'short', month:'short', day:'numeric', year:'numeric'
      })
    : '';

  const when = ev.date
    ? [dateStr, fmtTimeRange(ev.start, ev.end)].filter(Boolean).join(' • ')
    : (ev.openH || ev.closeH ? `Hours: ${[ev.openH, ev.closeH].filter(Boolean).join(' – ')}` : '');

  const where = ev.address || '';
  const metaText = [when, where].filter(Boolean).join('  —  ');
  pinMeta.textContent = metaText;
  pinMeta.style.display = metaText ? 'block' : 'none';

  // Description (truncate to 500 chars, expand on "…")
  const desc = (ev.desc || '').trim();
  if (desc){
    pinDesc.style.display = 'block';
    renderTruncatedDesc(desc, pinDesc, 500);
  } else {
    pinDesc.style.display = 'none';
    pinDesc.innerHTML = '';
  }

  // More Info (normalize to absolute URL)
  const direct = normalizeLink(ev.link);
  if (direct) {
    pinMore.style.display = 'inline-flex';
    pinMore.href = direct;
    pinMore.target = '_blank';
    pinMore.rel = 'noopener noreferrer';
  } else {
    pinMore.style.display = 'none';
    pinMore.removeAttribute('href');
  }

  // Menu button only for Restaurants (if present)
  const pinMenu = document.getElementById('pinMenu');
  if (pinMenu){
    const isRestaurant = (ev.category || '').toLowerCase().startsWith('restaurant');
    const menuLink = normalizeLink(ev.menu);
    if (isRestaurant && menuLink) {
      pinMenu.style.display = 'inline-flex';
      pinMenu.href = menuLink;
      pinMenu.target = '_blank';
      pinMenu.rel = 'noopener noreferrer';
    } else {
      pinMenu.style.display = 'none';
      pinMenu.removeAttribute('href');
    }
  }

  // Center map on selection (gentle), but NOT during intro animation
  if (!introAnimating && ev.lat != null && ev.lng != null) {
  map.easeTo({
    center:[ev.lng, ev.lat],
    duration: 700,
    zoom: Math.max(map.getZoom(), isMobile ? 13 : 14)
  });
}
}



  // Kick off
(async function init(){
  try {
    const raw = await loadSheet();
    allEvents = raw.map(normalize).filter(e => e.name && (e.lat!=null && e.lng!=null));

    render();

    // Default to first item in the sheet
    const first = allEvents[0];
    if (first) {
      // show card immediately
      selectEvent(first);

      // center after the intro animation completes (or immediately if none)
      const centerOnFirst = () => {
        if (first.lat != null && first.lng != null) {
          map.easeTo({
            center: [first.lng, first.lat],
            duration: 700,
            zoom: Math.max(map.getZoom(), isMobile ? 13 : 14)
          });
        }
      };

      if (introAnimating) {
        map.once('moveend', centerOnFirst);  // run after intro ease completes
      } else if (map.loaded()) {
        centerOnFirst();
      } else {
        map.once('load', centerOnFirst);
      }
    }
  } catch (err) {
    console.error('Sheet load failed', err);
    pinTitle.textContent = 'Could not load events';
    pinMeta.textContent  = 'Please check the Sheet ID & permissions (Publish to web).';
  }
})();


  </script>
</body>
</html>
