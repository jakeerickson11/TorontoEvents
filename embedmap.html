<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Events Widget</title>

  <!-- MapLibre 3.6.2 (UMD) -->
  <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- PMTiles -->
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

  <style>
    :root{
      --bg: #0b0b0b;           /* widget background */
      --panel: #121212;        /* pinned panel background */
      --text: #f3f3f3;         /* primary text */
      --muted: #a1a1aa;        /* secondary text */
      --accent: #0ea5e9;       /* accents & focus */
      --marker: #888;          /* default marker */
      --marker-promoted: #ff2d9b; /* hot pink */
      --ring: #fff;            /* white ring for map markers */
      --radius: 16px;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}

    /* --- Layout: Map (left) + Pinned panel (right) --- */
    .widget{
      display:grid; grid-template-columns: 1fr min(380px, 40%);
      gap: 10px; height: min(80vh, 760px); padding:10px;
    }
    #map{ width:100%; height:100%; border-radius: var(--radius); overflow:hidden; }

    .panel{
      background: var(--panel);
      border-radius: var(--radius);
      padding: 12px; display:flex; flex-direction:column; gap:12px;
      min-height:0; /* allow child scroll */
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .header{ display:flex; gap:8px; align-items:center; justify-content:space-between; }

    .dateFilter{
      appearance:none; background:#1c1c1c; color:var(--text);
      border:1px solid #2a2a2a; border-radius:10px; padding:8px 10px;
      outline:none; box-shadow:none; font:inherit; width: 100%;
    }

    .legend{ display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px; }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--marker); box-shadow:0 0 0 2px var(--ring) inset; }
    .dot.promo{ background:var(--marker-promoted); }

    .card{ background:#1a1a1a; border:1px solid #2a2a2a; border-radius:12px; overflow:hidden; }
    .card .media{ aspect-ratio: 16/9; background:#0d0d0d; display:block; width:100%; object-fit:cover; }
    .card .body{ padding:12px; }
    .title{ font-weight:700; font-size:16px; margin:0 0 2px; }
    .muted{ color:var(--muted); font-size:12px; }
    .desc{ margin-top:8px; color:#e7e7e7; font-size:13px; }
    .descMore{ cursor:pointer; color:var(--muted); }
    .descMore:hover{ text-decoration: underline; }



    
    .btns{ display:flex; gap:8px; margin-top:10px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #2c2c2c; background:#181818; color:#fff; text-decoration:none;
      padding:8px 10px; border-radius:10px; cursor:pointer; user-select:none;
      transition: transform .06s ease, border-color .2s;
    }
    .btn:hover{ border-color:#3a3a3a; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#03121a; font-weight:700; }

    /* --- Map marker styles (div markers) --- */

/* (Keep your promoted/static variants as-is) */

    .eventMarker--promoted{ --marker-color: var(--marker-promoted); width:10px; height:10px; box-shadow: 0 0 0 3px var(--ring), 0 2px 10px rgba(0,0,0,.35); filter: drop-shadow(0 0 10px var(--marker-promoted)); }
    /* ed number (optional) */
    .eventMarker__num{ position:absolute; inset:0; display:grid; place-items:; color:#000; font-weight:800; font-size:11px; text-shadow:0 1px 0 rgba(255,255,255,.6); }
    .eventMarker--static{ --marker-color: #14b8a6; } /* teal */


/* Base marker – let MapLibre position it */
.eventMarker{
  --marker-color: var(--marker);
  width:11px; height:11px;
  border-radius:999px;
  background: var(--marker-color);
  position: absolute;
  box-shadow: 0 0 0 2px var(--ring), 0 2px 8px rgba(0,0,0,.2);
  /* remove transform transition to prevent drift */
  transition: box-shadow .15s ease, filter .15s ease;
  opacity: .7;
}


/* Active highlight: scale only (no translate) */
.eventMarker.is-active{
  transform: scale(2); /* was 1.35 */
  box-shadow:
    0 0 0 3px var(--ring),
    0 0 0 10px rgba(105, 215, 255, .45),
    0 6px 18px rgba(0,0,0,.45);
  z-index: 10;
}


/* Leave your category/promoted classes as-is */


/* Extra glow for promoted when active */
.eventMarker--promoted.is-active{
  filter: drop-shadow(0 0 14px var(--marker-promoted));
}
    
    /* Small screens: stack panel under map */
    @media (max-width: 820px){
      .widget{ grid-template-columns: 1fr; height: auto; }
      .mapWrap{ height: 54vh; }
    }
    /* Optional: make the pretty date button look a bit more input-like */
#datePretty { font-weight:600; }

    /* Category colors */
.eventMarker--cat-restaurants{ --marker-color:#ff8a00; }  /* orange */
.eventMarker--cat-venues     { --marker-color:#3b82f6; }  /* blue   */
.eventMarker--cat-activities { --marker-color:#22c55e; }  /* green  */
.eventMarker--cat-shopping   { --marker-color:#a855f7; }  /* purple */
.eventMarker--cat-events     { --marker-color:#e11d48; }  /* red    */

/* (optional) if you still want a subtle cue for static (no date), add a faint outer glow */
.eventMarker--isStatic{
  box-shadow:
    0 0 0 2px var(--ring),
    0 0 0 6px rgba(255,255,255,.12),      /* subtle extra ring */
    0 2px 8px rgba(0,0,0,.2);
}

/* Hotel marker (bigger, gold, star icon) */
.eventMarker--hotel{
  --marker-color:#fbbf24; /* amber-400 */
  width:22px; height:22px;
  border-radius:999px;
  background: var(--marker-color);
  box-shadow:
    0 0 0 3px var(--ring),
    0 4px 14px rgba(0,0,0,.35);
  display:grid; place-items:;
}
.eventMarker--hotel svg{
  width:14px; height:14px; display:block;
  filter: drop-shadow(0 1px 0 rgba(255,255,255,.35));
}

/* keep active pop */
.eventMarker--hotel.is-active{
  transform: scale(1.25);
}

    /* Make sure clicking the hotel icon still clicks the marker */
.eventMarker--hotel svg { pointer-events: none; }

    /* markers must be click-through targets */
.maplibregl-marker{ pointer-events:auto; }
.eventMarker{ pointer-events:auto; cursor:pointer; }
/* hotel icon should not eat clicks */
.eventMarker--hotel svg{ pointer-events:none; }

/* Click highlight applied to the MapLibre wrapper */
.maplibregl-marker.is-active .eventMarker{
  transform: scale(2);
  box-shadow:
    0 0 0 3px var(--ring),
    0 0 0 15px rgba(105, 215, 255,.22),
    0 8px 24px rgba(0,0,0,.50);
  z-index: 10;
}

/* Hotel stays extra glowy when active */
.maplibregl-marker.is-active .eventMarker--hotel{
  transform: scale(1.4);
  box-shadow:
    0 0 0 4px var(--ring),
    0 0 0 10px rgba(251,191,36,.28),
    0 10px 28px rgba(0,0,0,.55);
}

/* Ensure clicks on the hotel SVG pass through to the wrapper */
.eventMarker--hotel svg { pointer-events: none; }

    /* Pills */
.pill {
  display:inline-flex; align-items:; gap:8px;
  padding:6px 10px; border-radius:999px; border:1px solid #2a2a2a;
  background:#141414; color:#eaeaea; cursor:pointer; user-select:none;
  font-size:12px; line-height:1; transition:background .15s, border-color .15s, color .15s;
}
.pill:hover { border-color:#3a3a3a; }
.pill.is-off { opacity:.55; color:#bdbdbd; background:#0e0e0e; }

.pill .swatch{
  width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px #fff;
}

/* match marker colors for quick recognition */
.swatch--restaurants{ background:#ff8a00; }
.swatch--venues     { background:#3b82f6; }
.swatch--activities { background:#22c55e; }
.swatch--shopping   { background:#a855f7; }
.swatch--events     { background:#e11d48; }

/* Reuse your .card styles; add an active/selected look */
.card.is-active{
  border-color:#3a93c9;
  box-shadow: 0 0 0 2px rgba(14,165,233,.35);
}

.card .actions{
  display:flex; gap:8px; margin-top:10px;
}

/* (small visual) tighten meta/desc spacing inside list cards */
.card .title{ margin-bottom:4px; }

    /* Scrollable list that fills the panel */
.list{
  flex: 1 1 auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;              /* a bit more space between cards */
  min-height: 0;
  padding-right: 4px;
}

/* Full-size cards that look like the old pinned layout */
.list .card{
  background:#1a1a1a;
  border:1px solid #2a2a2a;
  border-radius:12px;
  overflow:hidden;
  flex-shrink:0;
  display:flex;
  flex-direction:column;
}

/* Make sure the image is big enough to show detail */
.list .card .media{
  aspect-ratio:16/9;
  width:100%;
  object-fit:cover;
  display:block;
}

/* Body spacing just like your pinned event */
.list .card .body{
  padding:14px 14px 16px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* Meta + description comfortably visible */
.list .card .muted{ color:var(--muted); font-size:13px; }
.list .card .desc{ font-size:14px; line-height:1.45; color:#e7e7e7; }
.list .card .actions{ display:flex; gap:8px; margin-top:8px; }

/* Highlighted card */
.card.is-active{
  border-color:#3a93c9;
  box-shadow:0 0 0 2px rgba(14,165,233,.35);
}

    /* Sticky filters/header block */
.filters{
  position: sticky;
  top: 0;
  z-index: 3;
  background: var(--panel);
  padding-bottom: 8px;
  /* subtle divider under the sticky area */
  box-shadow: 0 1px 0 rgba(255,255,255,.06);
}

/* Ensure the list can scroll under the sticky filters */
.list{
  flex: 1 1 auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 0;
  padding-right: 4px;
}

    /* Pills row that can scroll horizontally if needed */
.pillsRow{ display:flex; flex-wrap:wrap; gap:6px; }


/* More compact pill */
.pill{
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 11px;
  gap: 6px;
}

/* Smaller color dot */
.pill .swatch{
  width: 8px; height: 8px;
  box-shadow: 0 0 0 1.5px #fff;
}

/* Count as a tiny badge */
.pill .count{
  font-size: 10px;
  opacity: .75;
}

.list { scroll-padding-top: var(--filters-h, 12px); }
.list .card { scroll-margin-top: var(--filters-h, 12px); }

    /* --------- Custom Scrollbar for the event list ---------- */
.list {
  scrollbar-width: thin;             /* Firefox */
  scrollbar-color: rgba(255,255,255,0.25) transparent;  /* Firefox track/thumb colors */
}

/* Chrome / Edge / Safari */
.list::-webkit-scrollbar {
  width: 10px;                       /* scrollbar width */
}

.list::-webkit-scrollbar-track {
  background: transparent;           /* invisible background */
}

.list::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.25); /* subtle white thumb */
  border-radius: 999px;               /* makes it a round “ball” */
  border: 2px solid transparent;      /* creates spacing around thumb */
  background-clip: padding-box;       /* ensures border acts as gap */
  transition: background 0.2s ease;
}

.list::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.45); /* brighter on hover */
}

.list::-webkit-scrollbar-thumb:active {
  background: rgba(14,165,233,0.6);   /* accent color when grabbing (blue-ish) */
}

/* Optional: slightly round the ends of the track for a softer look */
.list::-webkit-scrollbar-corner {
  background: transparent;
}

/* breathing room + smooth scroll */
.list{
  flex: 1 1 auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 0;
  padding: 0 4px 8px 0;   /* bottom pad helps when aligning to bottom */
  scroll-behavior: smooth;
  scroll-padding-bottom: 8px; /* extra safety for any scrollIntoView usage */
}

    /* ---- Category-specific marker shapes ---- */

/* Restaurants → small square */
.eventMarker--cat-restaurants {
  --marker-color: #ff8a00;      /* orange */
  width: 8px;
  height: 8px;
  border-radius: 1px;           /* subtle rounding = squarish */
  box-shadow:
    0 0 0 2px var(--ring),
    0 2px 4px rgba(255,255,255,.25);
}

/* Venues, Activities, Shopping, Events → standard circles */
.eventMarker--cat-venues,
.eventMarker--cat-activities,
.eventMarker--cat-shopping,
.eventMarker--cat-events {
  width: 11px;
  height: 11px;
  border-radius: 999px;
}

    .eventMarker--cat-restaurants.is-active {
  transform: scale(1.5) rotate(45deg); /* little diamond pop when clicked */
  box-shadow:
    0 0 0 3px var(--ring),
    0 0 0 10px rgba(255,138,0,.25),
    0 6px 16px rgba(0,0,0,.45);
}

    /* Make the map area a positioning context */
#mapWrap{
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: var(--radius);
  overflow: hidden;
}
#map{
  width:100%;
  height:100%;
}

/* Pills overlay at bottom of map */
.catPillsOverlay{
  position: absolute;
  left: 10px;
  right: 10px;
  bottom: 10px;
  z-index: 5;

  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;

  padding: 8px 10px;
  border-radius: 999px;

  background: rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  border: 1px solid rgba(255,255,255,.12);
}

/* Make pills a little smaller so they fit */
.catPillsOverlay .pill{
  padding: 6px 10px;
  font-size: 12px;
}

/* If your list panel scrolls, keep the map overlay from stealing scroll gestures */
.catPillsOverlay{ touch-action: manipulation; }

/* Optional: keep MapLibre bottom-right controls above the pills */
.maplibregl-ctrl-bottom-right{ margin-bottom: 58px; }

    .catPillsOverlay .pill{
  background: rgba(20,20,20,.55);
  border-color: rgba(255,255,255,.14);
}
.catPillsOverlay .pill.is-off{
  opacity: .55;
  background: rgba(10,10,10,.35);
}

/* the list should respect header height when scrolling */
.list{
  scroll-padding-top: var(--listHeaderH, 0px);
}

/* The whole widget must have a real height for internal scrolling */
.widget{
  height: min(80vh, 760px);
}

/* Panel must be a flex column and allow children to scroll */
.panel{
  display:flex;
  flex-direction:column;
  min-height:0;      /* CRITICAL for scroll containment */
}

/* Header area should not grow/shrink weirdly */
#listHeader{
  flex: 0 0 auto;
}

/* The list MUST be the scrolling area */
#eventList.list{
  flex: 1 1 auto;    /* take remaining space */
  min-height: 0;     /* CRITICAL for scroll containment */
  overflow-y: auto;
}

    .panel{
  position: relative;           /* allows absolute footer */
  background: var(--panel);
  border-radius: var(--radius);
  padding: 12px;
  display: flex;
  flex-direction: column;
  min-height: 0;                /* critical for scroll containers */
  overflow: hidden;             /* keeps footer inside rounded corners */
}

/* Scrollable list takes remaining height */
.list{
  flex: 1 1 auto;
  min-height: 0;                /* critical */
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-right: 4px;

  /* IMPORTANT: leave room so last item isn't under the footer */
  padding-bottom: 64px;
}

/* Footer overlay pinned to bottom-right */
.listFooter{
  position: absolute;
  right: 12px;
  bottom: 12px;
  z-index: 5;

  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: flex-end;

  /* optional: subtle pill background so it looks intentional */
  background: rgba(18,18,18,.75);
  border: 1px solid rgba(42,42,42,.9);
  border-radius: 999px;
  padding: 8px;
  backdrop-filter: blur(6px);
}

/* Mobile layout: ensure the map has an explicit height */
@media (max-width: 820px){
  .widget{
    grid-template-columns: 1fr;
    height: 100vh;          /* keeps everything on-screen */
    gap: 8px;
    padding: 8px;
  }

  .mapWrap{
    height: 46vh;           /* map stays visible */
  }

  .panel{
    height: calc(54vh - 8px);
  }

  /* pills stay on map, slightly tighter */
  .mapPills{
    left: 8px;
    right: 8px;
    bottom: 8px;
  }
}


    /* Collapsed by default */
.list .card .details{ display:none; }

/* Expand the selected card */
.list .card.is-active .details{ display:block; }

/* Optional: make collapsed cards more compact */
.list .card .body{ padding:12px; }
.list .card .title{ margin:0; }

/* map wrapper so overlays can be positioned inside it */
.mapWrap{
  position: relative;
  width: 100%;
  height: 100%;
  border-radius: var(--radius);
  overflow: hidden;
}

/* map fills wrapper */
#map{
  width: 100%;
  height: 100%;
}

/* pills sit ON TOP of map, pinned to bottom */
.mapPills{
  position: absolute;
  left: 10px;
  right: 10px;
  bottom: 10px;
  z-index: 5;

  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;

  pointer-events: none; /* allow map drag */
}

/* pills clickable even though container is pointer-events:none */
.mapPills .pill{
  pointer-events: auto;
}

/* keep pills compact so they don’t wrap offscreen too much */
.mapPills .pill{
  padding: 5px 8px;
  font-size: 11px;
  gap: 6px;
}
.mapPills .pill .swatch{
  width: 9px;
  height: 9px;
}

/* if your panel/list looks separated, this removes "mystery spacing" */
.widget{
  gap: 10px;           /* adjust if you want tighter */
}
.panel{
  min-height: 0;
}
.list{
  min-height: 0;
}

/* Mobile: lock the whole widget to the viewport, only list scrolls */
@media (max-width: 820px){
  html, body{ height:100%; }
  body{ overflow:hidden; }            /* prevents page scroll */

  .widget{
    grid-template-columns: 1fr;
    height: 100vh;
    padding: 8px;
    gap: 8px;
  }

  /* 40% map, 60% list */
  .mapWrap{ height: 40vh; }
  .panel{ height: calc(60vh - 8px); } /* subtract gap so total ~100vh */

  /* make sure children can scroll properly */
  .panel{ min-height:0; }
  .list{ min-height:0; overflow-y:auto; }

  /* slightly smaller list cards on mobile */
  .list .card .body{
    padding: 10px 12px 12px;
    gap: 4px;
  }
  .list .card .title{ font-size:15px; }
  .list .card .muted{ font-size:12px; }
  .list .card .desc{ font-size:13px; line-height:1.35; }

  /* smaller image so cards aren't huge */
  .list .card .media{ aspect-ratio: 16/10; }
}

    /* Card category indicator */
.card{
  position: relative;
}

/* small dot next to title */
.card .titleRow{
  display:flex;
  align-items:center;
  gap:8px;
}

.card .catDot{
  width:10px;
  height:10px;
  border-radius:999px;
  box-shadow: 0 0 0 2px rgba(255,255,255,.25);
  flex:0 0 auto;
  margin-top:1px;
}

/* optional: left stripe */
.card::before{
  content:"";
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:6px;
  background: transparent;
}

/* per-category colors (matches your markers) */
.card--cat-restaurants::before{ background:#ff8a00; }
.card--cat-venues::before     { background:#3b82f6; }
.card--cat-activities::before { background:#22c55e; }
.card--cat-shopping::before   { background:#a855f7; }
.card--cat-events::before     { background:#e11d48; }

.card--cat-restaurants .catDot{ background:#ff8a00; }
.card--cat-venues      .catDot{ background:#3b82f6; }
.card--cat-activities  .catDot{ background:#22c55e; }
.card--cat-shopping    .catDot{ background:#a855f7; }
.card--cat-events      .catDot{ background:#e11d48; }

@media (max-width: 820px){
  .list .card .desc,
  .list .card .actions,
  .list .card .media{
    display:none;
  }

  /* when selected, expand */
  .list .card.is-active .desc,
  .list .card.is-active .actions,
  .list .card.is-active .media{
    display:block;
  }
}

    .mapWrap{
  position: relative;
  width:100%;
  height:100%;
  border-radius: var(--radius);
  overflow:hidden;
}

#map{
  width:100%;
  height:100%;
}

/* Date button overlay */
.dateBtnOnMap{
  position:absolute;
  top:10px;
  left:10px;
  z-index: 5;
  padding:8px 10px;
  border-radius: 12px;
  backdrop-filter: blur(6px);
  background: rgba(15,15,15,.65);
  border: 1px solid rgba(255,255,255,.14);
}

/* Make sure controls stay above map */
.maplibregl-control-container{ z-index: 4; }

    /* --- Glass UI --- */
.glass {
  background: rgba(18,18,18,.55);
  border: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 999px;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
}

/* Date button sitting on the map */
.dateBtnOnMap{
  position:absolute;
  top:10px;
  left:10px;
  z-index:5;
  padding:8px 10px;
}

/* Make the date button itself look glassy (if you want the button = the glass) */
.dateBtnOnMap.btn{
  background: rgba(18,18,18,.55);
  border: 1px solid rgba(255,255,255,.10);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* Pills container sits on bottom of map and has glass background */
.catPillsOnMap{
  position:absolute;
  left:10px;
  bottom:10px;
  z-index:5;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  max-width: calc(100% - 20px);
  padding:8px;
}

/* Pills smaller so they don’t run off-screen */
.pill{
  padding:5px 8px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
}
.pill.is-off{ opacity:.55; }

    

  </style>
</head>
<body>

<div class="glass" style="position:absolute; top:10px; left:10px; z-index:5; padding:6px;">
  <button id="datePretty" class="btn" type="button" style="padding:8px 10px;"></button>
</div>

  
  <div class="widget" id="widgetRoot">
<div class="mapWrap">
  <div id="map"></div>

  <!-- Date overlay (top-left of map) -->
  <button id="datePretty" class="btn dateBtnOnMap" type="button"></button>
  <button id="datePretty" class="dateBtnOnMap btn" type="button"></button>

  <!-- Keep the real input hidden (used to open native picker) -->
  <input id="dateFilter" class="dateFilter" type="date"
         style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;"
         aria-hidden="true" />

<div id="catPills" class="catPillsOnMap glass"></div>
<div id="mapPills" class="mapPills"></div>
  
</div>

<aside class="panel">
  <!-- remove date picker row from here -->
  <div id="eventList" class="list"></div>
</aside>


  </div>

  <script>
  /*****************************************************************
   * EMBED-READY WIDGET (single file)
   *
   * Configure via the CONFIG object below OR via query params:
   *   ?sheet=SPREADSHEET_ID&tab=Sheet1&style=STYLE_URL&pm=PMTILES_URL
   *   &hotelName=Soho%20Hotel%20Toronto&hotelLat=43.64&hotelLng=-79.39
   *****************************************************************/
 if (!window.maplibregl) {
      const el = document.getElementById('map');
      el.style.display = 'grid';
      el.style.placeItems = 'center';
      el.style.color = '#bbb';
      el.innerHTML = 'Map library failed to load. Try self-hosting or check CDN blockers.';
      throw new Error('MapLibre not loaded');
    }

    
    
  const CONFIG = {
    SHEET_ID: "11ypk6inWH_ssq1giGnHOhOJg8_sVjlzExoKoWWXt_RU",     // Google Sheet ID (viewable/Published to web)
    SHEET_TAB: "Events",                   // Sheet/tab name
    STYLE_URL: "https://todoto.ca/style.json",  // Your MapLibre style.json (can reference pmtiles)
    PMTILES_URL: "",                       // Optional: pmtiles URL if your style references pmtiles:// URLs
    HOTEL_ORIGIN: {                         // Origin for directions
      name: "SoHo Hotel Toronto",
      lat: 43.64472457308373,  // e.g., 43.64274
      lng: -79.3922206565273   // e.g., -79.39478
    },
    MAP: {
      center: [-79.3922206565273, 43.64472457308373], // [lng, lat] – Queen's Park default
      zoomDesktop: 10,
      zoomMobile: 10,
      pitch: 0,
      bearing: -15 // subtle clockwise rotation
    }
  };
//GLOBALS//
let activeKey = null;
let activeWrapperEl = null;
let activeMarkerEl = null;
let hotelKey = null; // add near your other globals (activeKey, etc.)
// Tune this until the image top lines up perfectly under your header/date selector
let SCROLL_PAD_PX = 50;   // try 12, 20, 28, etc.
// Category palette + order
const CAT_ORDER = ['Restaurants','Venues','Activities','Shopping','Events'];
const CAT_COLORS = {
  Restaurants:'#ff8a00', Venues:'#3b82f6', Activities:'#22c55e', Shopping:'#a855f7', Events:'#e11d48'
};
// Active category set (start with all on)
const activeCats = new Set(CAT_ORDER);
// pill root
const catPillsRoot = document.getElementById('mapPills'); // instead of #catPills


let activeListEl = null;
// removes old active card, sets new one, and expands it (if you add CSS for collapse)
function setActiveCard(card){
  if (activeListEl) activeListEl.classList.remove('is-active');
  activeListEl = card || null;
  if (activeListEl) activeListEl.classList.add('is-active');
}
// scroll so the card's TOP sits just below your header/footer controls
function scrollCardBelowHeader(card){
  if (!eventList || !card) return;

  const header = document.getElementById('listHeader'); // your date control container
  const headerH = header ? header.offsetHeight : 0;

  // ✅ tweak this number to fine-tune the spacing
  const EXTRA_PAD = 10;

  // compute desired scrollTop so card's top aligns under header
  const target = card.offsetTop - headerH - EXTRA_PAD;

  eventList.scrollTo({
    top: Math.max(0, target),
    behavior: 'smooth'
  });
}

    
   


const makeKey = (e) => [e.name, e.date || '', e.lat, e.lng].join('|');

function highlightMarker(wrapperEl, key){
  if (activeWrapperEl) activeWrapperEl.classList.remove('is-active');
  activeWrapperEl = wrapperEl;
  activeKey = key;
  wrapperEl.classList.add('is-active');
}


    

  // Allow overrides by query params for easy per-hotel embeds
  const qp = new URLSearchParams(location.search);
  if (qp.get('sheet')) CONFIG.SHEET_ID = qp.get('sheet');
  if (qp.get('tab')) CONFIG.SHEET_TAB = qp.get('tab');
  if (qp.get('style')) CONFIG.STYLE_URL = qp.get('style');
  if (qp.get('pm')) CONFIG.PMTILES_URL = qp.get('pm');
  if (qp.get('hotelName')) CONFIG.HOTEL_ORIGIN.name = qp.get('hotelName');
  if (qp.get('hotelLat')) CONFIG.HOTEL_ORIGIN.lat  = parseFloat(qp.get('hotelLat'));
  if (qp.get('hotelLng')) CONFIG.HOTEL_ORIGIN.lng  = parseFloat(qp.get('hotelLng'));


// Debug: confirm MapLibre loaded and supports custom protocols
console.log('MapLibre version:', maplibregl && maplibregl.version);
console.log('addProtocol exists?', !!(maplibregl && maplibregl.addProtocol));
    
  // Always register pmtiles:// protocol so styles can reference pmtiles:// URLs
  const protocol = new pmtiles.Protocol();    
  maplibregl.addProtocol("pmtiles", protocol.tile);
  // Preload for faster first paint (optional)
  if (CONFIG.PMTILES_URL){
    const p = new pmtiles.PMTiles(CONFIG.PMTILES_URL);
    protocol.add(CONFIG.PMTILES_URL, p);
  }

// Compute a ~km-based bounding box around [lng,lat]
function kmBounds([lng, lat], km){
  const R_LAT = 111.32;                  // km per degree latitude
  const rad   = lat * Math.PI / 180;
  const dLat  = km / R_LAT;
  const dLng  = km / (R_LAT * Math.cos(rad));
  return [
    [lng - dLng, lat - dLat],            // [west, south]
    [lng + dLng, lat + dLat]             // [east, north]
  ];
}   
    // build map 
// build map
// build map (start view so there's no flash)
const isMobile  = matchMedia('(max-width: 820px)').matches;
const finalZoom = isMobile ? CONFIG.MAP.zoomMobile : CONFIG.MAP.zoomDesktop;
const startZoom = Math.max(3, finalZoom - 0.8);

const map = new maplibregl.Map({
  container: 'map',
  style: CONFIG.STYLE_URL,
  center: CONFIG.MAP.center,
  zoom: startZoom,
  minZoom: 10,
  maxZoom: 18,// start slightly zoomed out
  pitch: 0,          // flat at start
  bearing: 0,        // no rotation at start
  attributionControl: true,
  hash: false
});

// Lock panning to 5km around SoHo Hotel
const hotelCenter = [CONFIG.HOTEL_ORIGIN.lng, CONFIG.HOTEL_ORIGIN.lat];
const lockBounds  = kmBounds(hotelCenter, 5);
map.setMaxBounds(lockBounds);


    
let introAnimating = false;
// Respect prefers-reduced-motion, allow ?forceAnim=1 to override, ?noAnim=1 to disable
const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
const forceAnim = (qp.get('forceAnim') === '1');
const doAnim = forceAnim || (!prefersReduced && !qp.get('noAnim'));

map.once('load', () => {
  if (doAnim) {
    introAnimating = true;
    // small raf ensures layout is ready, avoids rare jump/cancel
    requestAnimationFrame(() => {
      map.easeTo({
        center:  CONFIG.MAP.center,
        zoom:    15,
        bearing: -15,   // ← final rotation
        pitch:   CONFIG.MAP.pitch,
        duration: 1400,
        easing: t => 1 - Math.pow(1 - t, 3)
      });
      map.once('moveend', () => { introAnimating = false; });
    });
  } else {
    map.jumpTo({
      center:  CONFIG.MAP.center,
      zoom:    finalZoom,
      bearing: CONFIG.MAP.bearing,
      pitch:   CONFIG.MAP.pitch
    });
  }
});


map.on('load', () => {
  const keep = ['road', 'highway', 'street'];
  map.getStyle().layers.forEach(l => {
    if (l.type === 'symbol' && !keep.some(k => l.id.toLowerCase().includes(k))) {
      map.setLayoutProperty(l.id, 'visibility', 'none');
    }
  });
});

    
  // Remove maplibre logo (if desired, keep attribution per license)
  map.addControl(new maplibregl.NavigationControl({showCompass:false, showZoom:false}), 'bottom-right'); // Zoom buttons hidden

  // Data state
  let allEvents = [];
  const markers = [];

//Elements//
  const dateFilter = document.getElementById('dateFilter');
  const datePretty = document.getElementById('datePretty');
  const filtersEl  = document.getElementById('filters');
const eventList  = document.getElementById('eventList');
let   filtersH   = 0;

function updateFiltersHeight(){
  if (!filtersEl || !eventList) return;
  // measure and store
  filtersH = filtersEl.offsetHeight || 0;
  // expose to CSS and built-in scrolling offsets
  eventList.style.setProperty('--filters-h', filtersH + 'px');
  eventList.style.scrollPaddingTop = filtersH + 'px';
}

// run on load + when layout might change
updateFiltersHeight();
window.addEventListener('resize', updateFiltersHeight);



function updateDatePretty(){
  const v = dateFilter.value;
  if (!v){ datePretty.textContent = 'Select date'; return; }
  const d = new Date(v + 'T00:00:00');
  datePretty.textContent = d.toLocaleDateString(undefined, {
    weekday:'short', month:'short', day:'numeric', year:'numeric'
  });
}
updateDatePretty();

// Open native picker when button is clicked (works across browsers)
datePretty.addEventListener('click', () => {
  openNativeDatePicker(dateFilter, datePretty);
});

// Keep label + map in sync on change
dateFilter.addEventListener('change', () => { updateDatePretty(); render(); });

// Optional: keyboard accessibility on the button
datePretty.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openNativeDatePicker(dateFilter, datePretty); }
});


    // --- Default date selector to today ---
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
dateFilter.value = `${yyyy}-${mm}-${dd}`;
    updateDatePretty();

  // Sheet -> JSON loader (Google Visualization API, public readable)
  async function loadSheet(){
    if(!CONFIG.SHEET_ID) throw new Error('Missing CONFIG.SHEET_ID');
    const url = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(CONFIG.SHEET_TAB)}`;
    const res = await fetch(url, {cache:'no-store'});
    const text = await res.text();
    const json = JSON.parse(
  text
    .replace(/^[\s\S]*setResponse\(/, '') // strip everything up to setResponse(
    .replace(/\);\s*$/, '')                // strip the trailing );
);

    return gvizToObjects(json);
  }

  // Convert Google Visualization JSON to array of objects with normalized keys
  function gvizToObjects(gv){
    const cols = gv.table.cols.map(c => (c.label || c.id || '').trim());
    const rows = gv.table.rows.map(r => r.c.map(c => c ? c.v : null));
    return rows.map(arr => Object.fromEntries(cols.map((k,i)=>[k, arr[i]])));
  }

  // Basic normalizer for expected schema
function normalize(ev){
    const get = (k, fallback='') => (ev[k] ?? ev[k?.toLowerCase?.()] ?? fallback);
  const num = (n) => (n==null || n==="" ? null : Number(n));

  const name  = String(get('Event name') || get('Name') || get('Title') || 'Event').trim();
  const date  = (get('Date') || '').toString().slice(0,10);
  const start = (get('Start') || get('Time') || '').toString();
  const end   = (get('End') || '').toString();
  const rawCat= String(get('Category') || 'Other').trim();
  const link  = String(get('Link') || get('URL') || '').trim();
  const addr  = String(get('Address') || '').trim();
  const photo = String(get('Photo') || '').trim();
  const openH = String(get('Open') || get('Open Hours') || '').trim();
  const closeH= String(get('Close') || get('Close Hours') || '').trim();
  const cuisine = String(get('Cuisine') || '').trim();     // ← NEW
  const menu  = String(get('Menu') || get('Menu URL') || '').trim();
  const lat   = num(get('Lat'));  const lng = num(get('Lng'));

  
  // Robust description: accept several possible headers
  const descRaw =
      get('Description')
   || get('Desc')
   || get('About')
   || get('Details')
   || get('Summary')
   || get('Notes')
   || '';
  const desc  = String(descRaw ?? '').trim();

  

  const promoted = /^(1|true|yes|y)$/i.test(String(get('Promoted')||'').trim());
  const isStatic = !date; // no Date = static venue (always show)

  // normalize to 5 buckets (keeps your existing class logic working)
  const lc = rawCat.toLowerCase();
  let category = 'Other';
  if (/^restaurant/.test(lc)) category = 'Restaurants';
  else if (/^venue/.test(lc)) category = 'Venues';
  else if (/^activit/.test(lc)) category = 'Activities';
  else if (/^shop/.test(lc)) category = 'Shopping';
  else if (/^event/.test(lc)) category = 'Events';
  else if (rawCat) category = rawCat;

  return { name, date, start, end, category, link, address:addr, photo, desc, openH, closeH, cuisine, menu, lat, lng, promoted, isStatic };
}


function openNativeDatePicker(dateInput, anchorEl){
  // Measure the pretty button and overlay the real input there
  const r = anchorEl.getBoundingClientRect();
  const s = dateInput.style;
  s.position   = 'fixed';
  s.left       = r.left + 'px';
  s.top        = r.top  + 'px';
  s.width      = r.width + 'px';
  s.height     = r.height + 'px';
  s.opacity    = 0;
  s.pointerEvents = 'auto';
  s.zIndex     = 9999;

  const cleanup = () => {
    // move offscreen again
    s.position = 'absolute';
    s.left = '-9999px';
    s.top  = '0';
    s.width = '1px';
    s.height= '1px';
    s.zIndex = '';
    s.pointerEvents = 'none';
  };

  const onDone = () => { cleanup(); dateInput.removeEventListener('blur', onDone); dateInput.removeEventListener('change', onDone); };

  dateInput.addEventListener('blur', onDone);
  dateInput.addEventListener('change', onDone);

  // Focus and try to open the picker
  dateInput.focus({preventScroll:true});
  // Prefer showPicker if supported (Chromium); fall back to click()
  if (typeof dateInput.showPicker === 'function') {
    try { dateInput.showPicker(); } catch {}
  } else {
    // Safari/Firefox – programmatic click usually works when focused & visible
    dateInput.click();
  }
}


  // Utility: Google Maps directions URL
  function gmapsDirUrl(origin, dest, mode='walking'){
    const params = new URLSearchParams({ api: '1', origin, destination: dest, travelmode: mode });
    return `https://www.google.com/maps/dir/?${params.toString()}`;
  }

  function fmtTimeRange(start, end){
    const s = start ? start : '';
    const e = end ? ` – ${end}` : '';
    return (s||e) ? `${s}${e}` : '';
  }

function formatHoursTime(val){
  if (!val) return '';

  // If already a string like "8:00a" / "8:00 AM"
  if (typeof val === 'string'){
    const s = val.trim();
    if (!s) return '';
    const m = s.match(/^(\d{1,2})(?::(\d{2}))?\s*([ap])\.?m?$/i) ||
              s.match(/^(\d{1,2})(?::(\d{2}))?\s*([ap])m$/i) ||
              s.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if (m){
      const hh = String(parseInt(m[1],10));
      const mm = String(m[2] ?? '00').padStart(2,'0');
      const ap = (m[3] || m[4] || '').toString().toLowerCase().startsWith('p') ? 'p' : 'a';
      return `${hh}:${mm}${ap}`;
    }
    return s; // leave as-is
  }

  // Date object (or timestamp)
  const d = (val instanceof Date) ? val : new Date(val);
  if (isNaN(d)) return String(val);

  let h = d.getHours();
  const m = d.getMinutes();
  const ap = h >= 12 ? 'p' : 'a';
  h = h % 12; if (h === 0) h = 12;

  return `${h}:${String(m).padStart(2,'0')}${ap}`;
}

function formatHoursRange(openVal, closeVal){
  const o = formatHoursTime(openVal);
  const c = formatHoursTime(closeVal);
  if (o && c) return `${o} - ${c}`;
  return o || c || '';
}



    
function hotelSVG(){
  // simple star; swap path if you prefer a “hotel” pictogram
  return `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2.5l2.7 5.5 6.1.9-4.4 4.3 1 6.1-5.4-2.9-5.4 2.9 1-6.1-4.4-4.3 6.1-.9L12 2.5z" fill="#7c4d00"/>
    </svg>`;
}

const pillEls = {}; // cat -> {root, labelEl, countEl}

function buildCatPills(){
  catPillsRoot.innerHTML = '';
  CAT_ORDER.forEach(cat => {
    const pill = document.createElement('button');
    pill.className = 'pill';
    pill.dataset.cat = cat;

    const sw = document.createElement('span');
    sw.className = 'swatch swatch--' + cat.toLowerCase();
    sw.style.boxShadow = '0 0 0 2px var(--ring)';

    const label = document.createElement('span');
    label.textContent = cat;

    const count = document.createElement('span');
count.className = 'count';
count.textContent = '(0)';

    pill.append(sw, label, count);
    catPillsRoot.appendChild(pill);

    pill.addEventListener('click', () => {
      if (activeCats.has(cat)) activeCats.delete(cat);
      else activeCats.add(cat);
      pill.classList.toggle('is-off', !activeCats.has(cat));
      render();                         // re-render markers + list
    });

    pillEls[cat] = { root:pill, labelEl:label, countEl:count };
  });
}
buildCatPills();

// Recompute pill counts given a set of rows (usually filtered by date)
function updatePillCounts(rows){
  // count by category in the supplied rows
  const counts = CAT_ORDER.reduce((acc, c) => (acc[c]=0, acc), {});
  rows.forEach(e => { if (counts[e.category] != null) counts[e.category]++; });

  // write counts and "off" state
  CAT_ORDER.forEach(cat => {
    const { root, countEl } = pillEls[cat] || {};
    if (!root) return;
    countEl.textContent = `(${counts[cat] || 0})`;
    root.classList.toggle('is-off', !activeCats.has(cat));
  });
}


function setActiveCard(card){
  if (activeListEl) activeListEl.classList.remove('is-active');
  if (card){
    card.classList.add('is-active');
    activeListEl = card;
  } else {
    activeListEl = null;
  }
}


function makeCard(ev){
  const card = document.createElement('div');
  card.className = 'card';

  const catSlug = (ev.category || 'other').toLowerCase().replace(/\s+/g,'-');
card.classList.add(`card--cat-${catSlug}`);

  const body = document.createElement('div');
  body.className = 'body';

 const titleRow = document.createElement('div');
titleRow.className = 'titleRow';

const dot = document.createElement('span');
dot.className = 'catDot';

const h = document.createElement('h3');
h.className = 'title';
h.textContent = ev.name || 'Event';

titleRow.append(dot, h);
body.appendChild(titleRow);


  const meta = document.createElement('div');
  meta.className = 'muted';
  const dateStr = ev.date ? new Date(ev.date+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}) : '';
  const when = ev.date ? [dateStr, fmtTimeRange(ev.start, ev.end)].filter(Boolean).join(' • ')
                       : (ev.openH || ev.closeH ? `Hours: ${[ev.openH, ev.closeH].filter(Boolean).join(' – ')}` : '');
  const where = ev.address || '';
  meta.textContent = [when, where].filter(Boolean).join('  —  ');
  if (meta.textContent) body.appendChild(meta);

  // Details (only visible when active)
  const details = document.createElement('div');
  details.className = 'details';

  if (ev.photo){
    const img = document.createElement('img');
    img.className = 'media';
    img.alt = ev.name || 'Photo';
    img.src = ev.photo;
    details.appendChild(img);
  }

  if (ev.desc){
    const d = document.createElement('div');
    d.className = 'desc';
    renderTruncatedDesc(ev.desc, d, 500);
    details.appendChild(d);
  }

  const actions = document.createElement('div');
  actions.className = 'actions';

  const direct = normalizeLink(ev.link);
  if (direct){
    const more = document.createElement('a');
    more.className = 'btn';
    more.href = direct; more.target = '_blank'; more.rel = 'noopener';
    more.textContent = 'More Info';
    actions.appendChild(more);
  }

  if ((ev.category || '').toLowerCase() === 'restaurants'){
    const menuLink = normalizeLink(ev.menu);
    if (menuLink){
      const menuA = document.createElement('a');
      menuA.className = 'btn';
      menuA.href = menuLink; menuA.target = '_blank'; menuA.rel = 'noopener';
      menuA.textContent = 'Menu';
      actions.appendChild(menuA);
    }
  }

  if (actions.children.length) details.appendChild(actions);

  body.appendChild(details);
  card.appendChild(body);
  return card;
}


function scrollCardBelowHeader(card){
  if (!eventList || !card) return;

  // Header area ABOVE the list (date + pills)
  const header = document.getElementById('filters') || document.getElementById('listHeader');
  const headerH = header ? header.getBoundingClientRect().height : 0;

  // Card top relative to the list scroll container
  const cardTop = card.offsetTop;

  // Scroll so the card's top sits just BELOW the header, with adjustable padding
  const targetTop = Math.max(0, cardTop - headerH + SCROLL_PAD_PX);

  eventList.scrollTo({ top: targetTop, behavior: 'smooth' });
}







    
// Render markers for current filter
// Render markers + list for current filters
function render(){
  // clear old markers & list
  markers.splice(0).forEach(obj => obj.marker.remove());
  if (eventList) eventList.innerHTML = '';
  activeListEl = null;

  const chosenDate = dateFilter.value ? dateFilter.value : '';

  // Category + date filter (static rows always show for date)
  const filtered = allEvents.filter(e => {
    if (!activeCats.has(e.category)) return false;
    if (!chosenDate) return true;
    if (!e.date) return true;
    return e.date === chosenDate;
  });

  // Update dynamic pill counts for what’s visible under current date
  if (typeof updatePillCounts === 'function') updatePillCounts(filtered);

  // If selected pin won't be in this render, clear highlight pointer
  if (activeKey && !filtered.some(e => makeKey(e) === activeKey)) {
    if (activeWrapperEl) activeWrapperEl.classList.remove('is-active');
    activeKey = null;
    activeWrapperEl = null;
  }

  // Promoted first for z-index layering
  const ordered = [
    ...filtered.filter(e => e.promoted),
    ...filtered.filter(e => !e.promoted)
  ];

  ordered.forEach((ev) => {
    if (ev.lat == null || ev.lng == null) return;

    const key = makeKey(ev);
    const isHotel = (typeof hotelKey === 'string' && hotelKey === key);

    // ----- Marker element
    const el = document.createElement('div');
    if (isHotel){
      el.className = 'eventMarker eventMarker--hotel';
      if (typeof hotelSVG === 'function') el.innerHTML = hotelSVG();
    } else {
      const catSlug = (ev.category || 'other').toLowerCase().replace(/\s+/g,'-');
      el.className =
        'eventMarker' +
        ` eventMarker--cat-${catSlug}` +
        (ev.promoted ? ' eventMarker--promoted' : '') +
        (!ev.date ? ' eventMarker--isStatic' : '');
    }

    const marker = new maplibregl.Marker({ element: el, anchor: 'center' })
      .setLngLat([ev.lng, ev.lat])
      .addTo(map);

    const wrapperEl = marker.getElement(); // <div class="maplibregl-marker">

    // ----- List card
    const card = (typeof makeCard === 'function') ? makeCard(ev) : null;
    if (eventList && card) eventList.appendChild(card);

    // Restore active highlight if this is selected
    if (activeKey && key === activeKey) {
      wrapperEl.classList.add('is-active');
      activeWrapperEl = wrapperEl;
      if (card) setActiveCard(card);

    }

    // Store
    markers.push({ marker, wrapperEl, el, ev, key, card });

    // -------- shared picker (marker OR card)
const pickThis = (e) => {
  if (e && e.stopPropagation) e.stopPropagation();
  if (e && e.preventDefault) e.preventDefault();

  // marker highlight + map behavior
  highlightMarker(wrapperEl, key);
  selectEvent(ev); // this will call setActiveCard + scroll too (see next step)
};


    // Click on marker (wrapper + inner element)
    wrapperEl.addEventListener('click', pickThis, { passive: false });
    el.addEventListener('click', pickThis, { passive: false });

    // Click on card
    if (card){
      card.addEventListener('click', pickThis, { passive: false });
    }
  });
}

function normalizeLink(u) {
  if (!u) return '';
  const s = String(u).trim();

  // already absolute
  if (/^https?:\/\//i.test(s)) return s;

  // protocol-relative //example.com
  if (/^\/\//.test(s)) return 'https:' + s;

  // bare www.example.com or example.com/path
  if (/^[\w.-]+\.[a-z]{2,}(\/.*)?$/i.test(s)) return 'https://' + s;

  // mailto:, tel:, etc. (leave as-is)
  return s;
}

function sanitizeDesc(html){
  if (!html) return '';

  // Convert raw URLs to links first (basic)
  html = html.replace(/(^|\s)((https?:\/\/)?[\w.-]+\.[a-z]{2,}(\/\S*)?)/ig, (m, pre, url) => {
    const hasScheme = /^https?:\/\//i.test(url);
    const href = hasScheme ? url : 'https://' + url;
    return `${pre}<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });

  // Replace newlines with <br>
  html = html.replace(/\n/g, '<br>');

  // Very light sanitize: keep only a small set of tags
  const allowed = /<(\/)?(br|b|strong|i|em|a)(\s+[^>]*)?>/gi;

  return html
    .replace(/</g, '&lt;')
    .replace(/&lt;(\/)?(br|b|strong|i|em|a)(\s+[^>]*)?&gt;/gi, (m) => {
      // re-enable allowed tags
      return m
        .replace('&lt;', '<')
        .replace('&gt;', '>');
    });
}

function renderTruncatedDesc(raw, el, limit = 500){
  const plain = String(raw || '');
  const cleanFull = sanitizeDesc(plain);

  if (plain.length <= limit){
    el.innerHTML = cleanFull;
    el.style.display = cleanFull ? 'block' : 'none';
    return;
  }

  // Make a truncated preview; avoid cutting mid-word for nicer look
  const cutAt = (() => {
    const soft = plain.slice(0, limit);
    const lastSpace = soft.lastIndexOf(' ');
    return lastSpace > 400 ? lastSpace : limit; // try to end near a word boundary
  })();

  const preview = sanitizeDesc(plain.slice(0, cutAt).trim());
  el.innerHTML = `${preview}<span class="descMore" aria-label="Show more">…</span>`;
  el.style.display = 'block';

  // One-time expand on click of the ellipsis
  const more = el.querySelector('.descMore');
  if (more){
    more.addEventListener('click', () => {
      el.innerHTML = cleanFull;
    }, { once: true });
  }
}

    
function selectEvent(ev){
  // center map gently (skip during intro anim)
  if (!introAnimating && ev.lat != null && ev.lng != null){
    map.easeTo({
      center: [ev.lng, ev.lat],
      duration: 700,
      zoom: Math.max(map.getZoom(), isMobile ? 13 : 14)
    });
  }

  // highlight the corresponding marker + list card
// highlight the corresponding marker + list card
const key   = makeKey(ev);
const found = markers.find(o => o.key === key);

if (found){
  highlightMarker(found.wrapperEl, key);

  if (found.card){
    setActiveCard(found.card);

    // wait a frame so "is-active" styles (expanded height) apply before scrolling
    requestAnimationFrame(() => scrollCardBelowHeader(found.card));
  }
}
}



  // Kick off
(async function init(){
  try {
    const raw = await loadSheet();
    allEvents = raw.map(normalize).filter(e => e.name && (e.lat!=null && e.lng!=null));
    
    if (allEvents.length) {
  hotelKey = makeKey(allEvents[0]); // first listed item is the hotel
}


    render();

    // Default to first item in the sheet
    const first = allEvents[0];
    if (first) {
      // show card immediately
      selectEvent(first);

      // center after the intro animation completes (or immediately if none)
      const centerOnFirst = () => {
        if (first.lat != null && first.lng != null) {
          map.easeTo({
            center: [first.lng, first.lat],
            duration: 700,
            zoom: Math.max(map.getZoom(), isMobile ? 13 : 14)
          });
        }
      };

      if (introAnimating) {
        map.once('moveend', centerOnFirst);  // run after intro ease completes
      } else if (map.loaded()) {
        centerOnFirst();
      } else {
        map.once('load', centerOnFirst);
      }
    }
  } catch (err) {
  console.error('Sheet load failed', err);
  // optionally show a small inline message somewhere if you want
}

})();


  </script>
</body>
</html>
