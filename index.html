<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>City Events Map</title>

 <!-- MapLibre GL + PMTiles -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />

<!-- MapLibre CSS (in <head> ideally, but okay here if needed) -->
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  
<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">

  <style>
/* ----- (same styles as your file, unchanged) ----- */
:root{
  --bg:#262626;        /* off-black page background */
  --card:#f2f2f2;      /* white panels for contrast */
  --muted:#7a8aa0;
  --text:#e6eef7;
  --cat-active:#16a34a;
  --cat-creative:#a855f7;
  --cat-entertain:#eab308;
  --cat-competitive:#f97316;
  --cat-relax:#3b82f6;
}
*{box-sizing:border-box}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
/* Dark header with bright text */
header{
  padding:16px 20px;
  border-bottom:1px solid #000000; /* subtle divider */
  position:sticky; top:0;
  background:#171717;            /* dark */
  color:#f8fafc;                  /* bright text */
  z-index:5;
}
header h1{ margin:0; font-size:20px; color:#f8fafc; }
header a{ color:#eeeeee; }        /* any header links/buttons */


.container{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; padding:16px}
#map{height: calc(100vh - 100px); border-radius:16px; overflow:hidden; border:1px solid #e5eaf1}
.panel{background:var(--card); border:1px solid #e5eaf1; border-radius:16px; overflow:hidden; display:flex; flex-direction:column}
.filters{padding:12px; border-bottom:1px solid #d4d4d4; display:grid; grid-template-columns: 1fr; gap:12px} /* change */
.filters .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.filters label{font-size:12px; color:var(--muted)}
.filters input{padding:8px 10px; border-radius:10px; border:1px solid #d0d7e2; background:#ffffff; color:var(--text)}
.filters .cats{display:flex; gap:8px; flex-wrap:wrap}
.chip{display:flex; gap:6px; align-items:center; font-size:12px; border:1px solid #d0d7e2; padding:6px 8px; border-radius:999px; background:#f8fafc; color:var(--text); cursor:pointer}
.dot{width:10px; height:10px; border-radius:999px; display:inline-block}
.cal{border:1px solid #e5eaf1; border-radius:12px; padding:8px; background:#ffffff; min-height:260px}
.cal-{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
.cal-nav{display:flex; gap:6px}
.cal-btn{padding:6px 10px; border:1px solid #d0d7e2; background:#ffffff; color:var(--text); border-radius:10px; cursor:pointer}
.cal-btn:disabled{opacity:.45; cursor:not-allowed}
.cal-title{font-size:12px; color:var(--muted)}
.cal-grid{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px}
.cal-wd{font-size:11px; color:#6b7280; text-align:center; padding:4px 0}
.cal-day{font-size:12px; text-align:center; padding:8px 0; border-radius:10px; border:1px solid #d0d7e2; background:#ffffff; cursor:pointer; user-select:none}
.cal-day:hover{border-color:#94a3b8}
.cal-day.out{opacity:.35; cursor:default}
.cal-day.disabled{opacity:.45; pointer-events:none}
.cal-day.selected{outline:2px solid var(--accent); outline-offset:1px}
.cal-day.hasEvents{background:#eef2ff}
.cal-legend{font-size:11px; color:#6b7280; margin-top:6px}
.list{overflow:auto; background:#ffffff}
.item{display:grid; grid-template-columns: 72px 1fr; gap:12px; padding:12px; border-bottom:1px solid #e5eaf1; cursor:pointer; background:#ffffff}
.item:hover{background:#f5f7fb}
.thumb{width:72px; height:72px; border-radius:12px; object-fit:cover; border:1px solid #e5eaf1}
.meta{display:flex; flex-direction:column; gap:4px}
.title{font-weight:600}
.sub{color:var(--muted); font-size:12px}
.badge{display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #d0d7e2; background:#ffffff}
.leftStripe{width:6px; border-radius:0 6px 6px 0}
.footer{padding:10px; font-size:12px; color:#d4d4d4}

@media (max-width: 960px){
  .container{grid-template-columns:1fr;}
  /* Fallback first, then better viewport units if supported */
  #map{
    height:42vh;   /* fallback */
    height:42svh;  /* small-viewport height */
    height:42dvh;  /* dynamic viewport height (best) */
  }
}

/* Make it even shorter on very small phones */
@media (max-width: 600px){
  #map{
    height:36vh;
    height:36svh;
    height:36dvh;
  }
}
@media (max-width: 420px){
  #map{
    height:32vh;
    height:32svh;
    height:32dvh;
  }
}
    
/* Make the right panel + controls readable on white */
.list,
.filters,
.badge,
.chip { background:#ffffff; color:#0f172a; border-color:#e5eaf1; }

.panel {
  /* keep your existing panel styles */
  height: calc(100vh - 100px); /* same as .map so they line up */
}

.list {
  flex: 1;
  min-height: 0;     /* new */
  overflow: auto;    /* you already had this — leave it in */
}
    
.filters input {
  background:#ffffff; color:#0f172a; border:1px solid #d0d7e2;
}

.meta .sub,
.filters label { color:#475569; }

.item { background:#ffffff; }
.item:hover { background:#f5f7fb; }
.thumb { border-color:#e5eaf1; }

/* Keep the  subtle on off-black; optional: */
/*  { background: linear-gradient(180deg, rgba(14,17,20,0.95), rgba(14,17,20,0.85)); } */

/* Pinned event bar (shows under  on phones) */
.pinned{ margin:8px 16px 0 16px; }
.pinned.hidden{ display:none; }
.pinnedCard{
  display:grid; grid-template-columns:64px 1fr; gap:12px; align-items:center;
  background:var(--card); color:var(--text);
  border:1px solid #e5eaf1; border-radius:12px; padding:10px;
}
.pinnedCard .thumb{
  width:64px; height:64px; border-radius:10px; object-fit:cover; border:1px solid #e5eaf1;
}
.pinnedTitle{ font-weight:600; }
.pinnedMeta{ font-size:12px; color:var(--muted); }
.pinnedBadge{
  display:inline-flex; align-items:center; gap:6px; font-size:11px;
  padding:4px 8px; border-radius:999px; border:1px solid #d0d7e2; background:#ffffff;
}
.pinned .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

/* Promoted tag used in the list */
.promotedTag{
  display:inline-flex; align-items:center; gap:6px;
  padding:3px 8px; border-radius:999px;
  background:#ff2d9b; color:#fff; font-size:11px; font-weight:700;
  border:1px solid rgba(0,0,0,.15);
  box-shadow:0 1px 2px rgba(0,0,0,.12);
  white-space:nowrap;
}
.promotedTag .star{ font-size:12px; line-height:1; }


/* Hide the pinned bar on desktop/tablet; only show on phones */
@media (min-width: 961px){
  .pinned{ display:none; }
}

/* Clear (×) button on pinned card */
.pinnedCard { position: relative; }
.pinnedClear{
  position:absolute; top:6px; right:6px;
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px;
  border:1px solid #d0d7e2; background:#ffffff; color:#475569;
  cursor:pointer; line-height:1; font-size:16px;
}
.pinnedClear:hover{ background:#f5f7fb; }
.pinnedClear:focus{ outline:2px solid var(--accent); outline-offset:2px; }

/* Slimmer list items on phones */
@media (max-width: 960px){
  .item{
    /* text left (1fr) + small image right (auto) */
    grid-template-columns: 1fr 56px;
    gap: 8px;
    padding: 8px 10px;
  }
  .item .leftStripe{ display:none; }        /* hide the side stripe to save space */
  .thumb{ width:56px; height:56px; }        /* smaller image */
  .meta{ gap: 2px; }                        /* tighter spacing between lines */
  .title{ font-size:14px; line-height:1.2; }
  .sub{ font-size:11px; line-height:1.2; }
  /*.badge{ display:none; }                   /* optional: hide category pill to reduce height */
}

/* Slimmer list items on phones */
@media (max-width: 960px){
  .item{
    /* text left (1fr) + small image right (auto) */
    grid-template-columns: 1fr 56px;
    gap: 8px;
    padding: 8px 10px;
  }
  .item .leftStripe{ display:none; }        /* hide the side stripe to save space */
  .thumb{ width:56px; height:56px; }        /* smaller image */
  .meta{ gap: 2px; }                        /* tighter spacing between lines */
  .title{ font-size:14px; line-height:1.2; }
  .sub{ font-size:11px; line-height:1.2; }
  .badge{ display:none; }                   /* optional: hide category pill to reduce height */
}
/* Title row with inline badge on phones */
@media (max-width: 960px){
  .titleRow{
    display:flex; align-items:center; gap:6px;
    min-width:0; /* lets ellipsis work */
  }
  .title{
    font-size:14px; line-height:1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    flex:1 1 auto; /* title can shrink */
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    font-size:10px; padding:2px 6px; border-radius:999px;
    border:1px solid #d0d7e2; background:#ffffff;
    white-space:nowrap; flex:0 0 auto; /* badge stays compact */
  }
  .badge .dot{ width:8px; height:8px; }
}

/* No horizontal scroll in the events list */
#eventsList { overflow-x: hidden; }

/* Mobile text wrapping & clamping */
@media (max-width: 960px){
  /* Let grid children shrink on small screens */
  .item > * { min-width: 0; }
  .meta     { min-width: 0; }

  /* Title on one line with badge… OR clamp to 2 lines (pick ONE style below) */

  /* A) Clamp title to 2 lines with ellipsis (recommended: fixed height, tidy) */
  .title{
    white-space: normal;              /* override any nowrap */
    display: -webkit-box;
    -webkit-line-clamp: 2;            /* show up to 2 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.2;
    font-size: 14px;
    overflow-wrap: anywhere;          /* break very long words if needed */
    word-break: break-word;
    hyphens: auto;
  }

  /* Sub-lines (venue, date/time, link) kept to 1 line with ellipsis */
  .sub{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Make sure the row itself can't create horizontal scroll */
  .item{
    overflow: hidden;     /* hide any accidental overflow */
  }
}
/* Make pinned event title dark on the white card */
.pinnedCard .pinnedTitle {
  color: #0f172a !important; /* deep near-black */
}

    /* Pinned card: make the category pill text dark */
.pinnedCard .pinnedBadge {
  color: #0f172a !important;   /* deep near-black text */
  background: #ffffff;         /* keep white pill */
  border-color: #d0d7e2;       /* subtle border */
}

/* ===== Fast sliding  (fixed) ===== */
:root{ ---h: 64px; }              /* JS will set real height */

/* Make  fixed so content never scrolls over it */
{
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 1000;
  transition: transform .12s ease;      /* faster animation */
  will-change: transform;
}

 Spacer reserves  height to avoid layout jump 
#Spacer{
  height: 0px;
}

 Hide  & collapse spacer 
.-hidden { transform: translateY(-100%); }
.-hidden #Spacer{ height: 0; }

/* ===== Stack order hardening: keep  on top of map layers ===== */

/* Make  the top-most thing */
{
  position: fixed;        /* you already have this from the slide-up setup */
  top: 0; left: 0; right: 0;
  z-index: 9999;          /* higher than any Leaflet pane/control */
  will-change: transform;
  backface-visibility: hidden; /* reduces flicker on iOS during fast scroll */
}

/* Keep the spacer + pinned card above the map but below the  */
#Spacer,
#pinnedEvent{
  position: absolute;
  z-index: 9999;
}

/* Desktop: stripe | text | image */
@media (min-width: 961px){
  .item{
    display: grid;
    grid-template-columns: 6px 1fr 64px;  /* stripe | text | image */
    gap: 10px;
    padding: 10px 12px;
    align-items: center;
  }
  .leftStripe{
    grid-column: 1;
    grid-row: 1 / -1;       /* run full height of the row */
    display: block;         /* make sure it’s visible */
  }
  .meta{
    grid-column: 2;         /* text on the left side */
    min-width: 0;           /* allow ellipsis/wrap */
    gap: 4px;
  }
  .thumb{
    grid-column: 3;         /* image on the right side */
    width: 64px;
    height: 64px;
    justify-self: end;
  }

  /* Make items thinner vertically */
  .title{
    white-space: normal;
    display: -webkit-box;
    -webkit-line-clamp: 2;      /* up to 2 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.2;
    font-size: 15px;
  }
  .sub{
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

/* Directions button */
.dirBtn{
  display:inline-flex; align-items:center; gap:6px;
  font-size:12px; padding:6px 10px; border-radius:10px;
  border:1px solid #d0d7e2; background:#ffffff; color:#0f172a;
  text-decoration:none; cursor:pointer;
}
.dirBtn:hover{ background:#f5f7fb; }

/* Pinned card: actions row (for Directions button) */
.pinnedActions{
  display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;
}

/* Selected list item highlight */
.item.selected{
  background: #eef2ff;                 /* subtle highlight */
  border-color: var(--accent);         /* optional, if your .item has a border */
}

.item { cursor: pointer; }
.item.selected { background:#eef2ff; border-color: var(--accent); }

/*  layout with inline date picker */
{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:12px; flex-wrap:wrap; z-index:9999; /* stays above map */
}
.Controls{ display:flex; align-items:center; gap:10px; }

 .Controls input[type="date"]{
  padding:8px 10px; border:1px solid #d0d7e2; border-radius:10px;
  background:#ffffff; color:#0f172a; font:inherit;
}

/* Hide Leaflet zoom buttons on mobile */
@media (max-width: 960px){
  /* .leaflet-control-zoom { display: none !important; }*/
}

/* Base marker — keep yours as-is */
.eventMarker{
  width:18px;height:18px;border-radius:999px;
  border:2px solid #080808;
  box-shadow:0 1px 3px rgba(0,0,0,.25);
  background:#888;            /* overwritten per category */
}

/* —— Size */
.eventMarker--sm{ width:12px; height:12px; }
.eventMarker--md{ width:18px; height:18px; }   /* default */
.eventMarker--lg{ width:24px; height:24px; }
.eventMarker--xl{ width:32px; height:32px; }

/* —— Shape */
.eventMarker--round{ border-radius:999px; }     /* default */
.eventMarker--square{ border-radius:6px; }
.eventMarker--diamond{
  transform:rotate(45deg); border-radius:4px;
}

/* —— Opacity/“ghost” style (slightly transparent like your Leaflet look) */
.eventMarker--ghost{ opacity:.8; backdrop-filter: blur(0.5px); }

/* —— Halo (readable on dark/light basemaps) */
.eventMarker--halo::after{
  content:"";
  position:absolute; inset:-1px;
  border-radius:inherit;
  box-shadow:0 0 0 5px rgba(255,255,255,.55);
  z-index:-1;
}

/* —— Glow (category-colored outer glow) */
.eventMarker--glow{
  filter: drop-shadow(0 0 6px currentColor);
}
/* if you want the glow to match the fill, set color via CSS var or inline style */

/* —— Inner bevel / “button” look */
.eventMarker--bevel{
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.25),
    0 1px 3px rgba(0,0,0,.25);
}

/* —— Stroke variants */
.eventMarker--thin { border-width:1px; }
.eventMarker--thick{ border-width:3px; }

/* —— Hover + Selected states */
.eventMarker:hover{
  transform: translateY(-1px) scale(1.05);
  transition: transform .12s ease, box-shadow .12s ease;
  z-index: 2;
}
.eventMarker.is-selected{
  box-shadow:0 0 0 3px #fff, 0 1px 6px rgba(0,0,0,.4);
  outline: 2px solid #111;               /* extra contrast */
  outline-offset: 2px;
}

/* Use a CSS var so glow matches the fill automatically */
.eventMarker{
  background: var(--marker-color, #888);
  color: var(--marker-color, #888); /* used by currentColor effects */
  box-shadow:
    0 0 0 1px #fff,          /* white ring for contrast */
    0 2px 8px rgba(0,0,0,.15);
  position: relative;
}

/* Promoted: larger, thicker stroke, white ring, glow + gentle pulse */
.eventMarker--promoted{
  --marker-color: #ff2d9b; 
  width:24px; height:24px;
  border-width:3px;
  box-shadow:
    0 0 0 3px #fff,          /* white ring for contrast */
    0 2px 8px rgba(0,0,0,.35);
  filter: drop-shadow(0 0 8px currentColor);
  animation: promotedPulse 1.4s ease-out infinite;
  z-index: 2;
}

/* Small star badge */
.eventMarker__badge{
  position:absolute; top:-6px; right:-6px;
  width:14px; height:14px; border-radius:999px;
  background:#111; color:#ffd600;
  font-size:10px; line-height:14px; text-align:center; font-weight:700;
  box-shadow:0 0 0 2px #fff, 0 1px 2px rgba(0,0,0,.25);
}

/* Pulse animation (respects reduced motion) */
@keyframes promotedPulse{
  0%   { box-shadow: 0 0 0 3px #fff, 0 2px 8px rgba(0,0,0,.35), 0 0 0 0 rgba(0,0,0,.18); }
  70%  { box-shadow: 0 0 0 3px #fff, 0 2px 8px rgba(0,0,0,.35), 0 0 0 12px rgba(0,0,0,0); }
  100% { box-shadow: 0 0 0 3px #fff, 0 2px 8px rgba(0,0,0,.35), 0 0 0 0 rgba(0,0,0,0); }
}
@media (prefers-reduced-motion: reduce){
  .eventMarker--promoted{ animation: none; }
}

/* Optional: always keep promoted above regular on hover stacks */
.eventMarker.is-selected{ z-index: 3; }


/* —— High-DPI crisp border */
@supports (outline:1px solid transparent){
  .eventMarker--crisp{ outline:1px solid rgba(0,0,0,.4); outline-offset:-1px; }
}

/* —— Category colors via data-attribute (no extra classes needed) */
.eventMarker[data-category="Active"]{ background:#16a34a; }
.eventMarker[data-category="Creative"]{ background:#a855f7; }
.eventMarker[data-category="Entertainment"]{ background:#eab308; }
.eventMarker[data-category="Competitive"]{ background:#f97316; }
.eventMarker[data-category="Relaxing"]{ background:#3b82f6; }

/* —— Focus ring (keyboard accessibility) */
.eventMarker:focus-visible{
  box-shadow:0 0 0 3px #fff, 0 0 0 5px #2563eb;
}

.eventMarker{
  background: var(--marker-color, #888); /* your JS still sets background too */
  position: absolute;
}

/* --- PROMOTED STYLE (bigger, thicker, white ring + glow + star) --- */
.eventMarker--promoted{
  --marker-color: #ff0000 !important;   /* red glow */
  position:absolute;
  width: 24px;           /* bigger than your 18px base */
  height: 24px;
  border-width: 3px;     /* thicker outline */
  box-shadow:
    0 0 0 3px #fff,      /* white ring for contrast */
    0 2px 8px rgba(0,0,0,.35);
  filter: drop-shadow(0 0 1px currentColor); /* color-matched glow */
  animation: 
   promotedRing 0.95s ease-in-out infinite,
}

/* little star badge in the corner */
.eventMarker__badge{
  position:absolute; 
  top:px; 
  right:0px;
  width:14px; 
  height:14px; 
  border-radius:999px;
  background:#11111100; 
  color:#ffd600;  /* gold star on dark dot */
  font-size:10px; 
  line-height:14px; 
  text-align:center; font-weight:700;
  box-shadow:0 0 0 2px #ffffff00, 0 1px 2px rgba(0,0,0,.25);
}

/* Center the existing badge inside promoted markers */
.eventMarker--promoted{ position: absolute; }  /* marker stays relative, NOT absolute */

.eventMarker--promoted .eventMarker__badge{
  position: absolute;
  inset: 0;                           /* fill the marker box */
  display: flex; align-items: center; justify-content: center;
  width: auto; height: auto;          /* let font size define size */
  margin: 0; padding: 0;
  background: transparent; border: 0; box-shadow: none;
  color: #fff;                        /* white star on hot pink */
  font-size: 15px;                    /* try 12–14 for a 24px marker */
  line-height: 1;
  pointer-events: none;               /* clicks hit the marker, not the star */
  text-shadow: 0 1px 2px rgba(0,0,0,.45);
}

/* animations */
@keyframes promotedBeat{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.10)} }
@keyframes promotedGlow{ 0%,100%{filter:drop-shadow(0 0 8px currentColor)} 50%{filter:drop-shadow(0 0 16px currentColor)} }
@keyframes promotedRing{
  0%{   box-shadow:0 0 0 0 rgba(255,45,155,.45); opacity:1 }
  70%{  box-shadow:0 0 0 16px rgba(255,45,155,0); opacity:0 }
  100%{ box-shadow:0 0 0 0 rgba(255,45,155,0); opacity:0 }
}
@keyframes twinkle{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.15) rotate(-12deg)} }
@media (prefers-reduced-motion: reduce){
  .eventMarker--promoted,
  .eventMarker--promoted::after,
  .eventMarker__badge{ animation:none; }
}

/* Blue circular "me" control (MapLibre control) */
.maplibregl-ctrl .meCtrl{
  width:36px;height:36px;border-radius:999px;
  background:#0ea5e9;color:#fff;border:2px solid #fff;
  font-weight:700;font-size:12px;text-transform:uppercase;
  line-height:1; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.25);
}

/* Hide zoom buttons on mobile */
@media (max-width:960px){
  .maplibregl-ctrl-zoom{ display:none !important; }
}

/* Dark, readable popup text */
.maplibregl-popup .maplibregl-popup-content,
.mapboxgl-popup   .mapboxgl-popup-content{
  color: #0b1320 !important;   /* dark navy/near-black text */
  background: #ffff !important;
}

/* Links inside the popup (optional: make them darker too) */
.maplibregl-popup .maplibregl-popup-content a,
.mapboxgl-popup   .mapboxgl-popup-content a{
  color: #0b1320 !important;
  text-decoration: underline;
}

/* Close “×” button color */
.maplibregl-popup .maplibregl-popup-close-button,
.mapboxgl-popup   .mapboxgl-popup-close-button{
  color: #0b1320 !important;
}

/* (Optional) stronger font weight for the title if you use <strong> */
.maplibregl-popup .maplibregl-popup-content strong,
.mapboxgl-popup   .mapboxgl-popup-content strong{
  color: #0b1320 !important;
}
    
/* Base size on desktop */
.maplibregl-ctrl-attrib {
  font-size: 12px;           /* smaller than default */
  line-height: 1.25;
  padding: 1px 3px;
  background: #383838;  /* optional: improve contrast on dark maps */
  color: #383838;
  border-radius: 3px;
}

/* Make links look like links but subtle */
.maplibregl-ctrl-attrib a {
  color: #000000;                 /* match control text color */
  text-decoration: underline;
  text-underline-offset: 2px;
}

/* On very small screens, make it even more compact */
@media (max-width: 640px) {
  .maplibregl-ctrl-attrib {
    font-size: 10px;
    padding: 2px 4px;
  }
}

/* Optional: always force the compact "i" button (if you prefer it everywhere) */
.maplibregl-ctrl-attrib.maplibregl-compact {
  min-width: 0;
}


.maplibregl-ctrl-attrib a: hover {
  color: #ffffff !important;
  text-decoration: underline;
}

/* If you’re using compact mode (the little “ⓘ” toggle), style its button too */
.maplibregl-ctrl-attrib .maplibregl-ctrl-attrib-button,
.mapboxgl-ctrl-attrib .mapboxgl-ctrl-attrib-button { /* fallback selector */
  background: #0b1320 !important;
  color: #e5e7eb !important;
  border: 1px solid #0f1b33 !important;
  border-radius: 8px;
}

/* Lighter attribution toggle button on dark background */
.maplibregl-ctrl-attrib .maplibregl-ctrl-attrib-button,
.mapboxgl-ctrl-attrib .mapboxgl-ctrl-attrib-button{
  background: #383838 !important;   /* light slate */
  color: #0b1320 !important;         /* dark navy text/icon */
  border: 1px solid #cbd5e1 !important;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,.25);
}

/* Hover / focus / active states for better contrast */
.maplibregl-ctrl-attrib .maplibregl-ctrl-attrib-button:hover,
.mapboxgl-ctrl-attrib .mapboxgl-ctrl-attrib-button:hover{
  background: #383838 !important;
}

.maplibregl-ctrl-attrib .maplibregl-ctrl-attrib-button:focus,
.mapboxgl-ctrl-attrib .mapboxgl-ctrl-attrib-button:focus{
  outline: none;
  box-shadow: 0 0 0 3px rgba(229,231,235,.7), 0 2px 4px rgba(0,0,0,.25); /* light ring */
}

/* When expanded, keep the button light */
.maplibregl-ctrl-attrib[aria-expanded="true"] .maplibregl-ctrl-attrib-button,
.mapboxgl-ctrl-attrib[aria-expanded="true"] .mapboxgl-ctrl-attrib-button{
  background: #0b1320 !important;
  color: #0b1320 !important;
}
/* ///////////HEADER/////////////// */
    /* Header layout: left = title, center = submit button, right = calendar */
/* Header: left (title) | center (calendar) | right (button) */
.siteHeader{
  position: sticky; top: 0; z-index: 1000;
  display: grid;
  grid-template-columns: 1fr minmax(280px, 520px) auto;
  align-items: center;
  gap: 14px;
  padding: 10px 16px;
  background: var(--header-bg, #0a0a0a);
  border-bottom: 1px solid rgba(0,0,0,.08);
}
.hdrLeft{ justify-self: start; }
.hdrCenter{ justify-self: center; width: 100%; }
.hdrRight{ justify-self: end; }

/* Big primary button (keep your existing if you already have it) */
.btnPrimary{
  display:inline-flex; align-items:center; justify-content:center;
  height:40px; padding:0 16px; border-radius:12px;
  background:#0ea5e9; color:#fff; font-weight:700; text-decoration:none;
  border:1px solid #0aa0d1; box-shadow:0 1px 3px rgba(0,0,0,.25);
}
.btnPrimary:hover{ filter: brightness(0.95); }

/* Accessibility helper */
.visuallyHidden{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0;
}

/* ===== Date picker: shared big control ===== */
.datePicker{
  /* make it big and readable */
  width:100%;
  height:56px;
  font-size:18px;
  line-height:56px;
  font-weight:600;
  padding:0 52px 0 16px;          /* right padding leaves room for icon */
  border-radius:16px;
  border:1px solid #cfd6e3;
  color:#0b1320;
  background:#646464;
  box-shadow:0 1px 3px rgba(0,0,0,.06);
  outline:none;
  /* remove native styling so we can fully style */
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background-image:
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="%23556" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>');
  background-repeat:no-repeat;
  background-position: right 16px center;
  background-size: 22px;
}
.datePicker:hover{ border-color:#b7c2d6; }
.datePicker:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25); }

/* Hide the native calendar icon on WebKit so our SVG shows */
.datePicker::-webkit-calendar-picker-indicator{ opacity:0; cursor:pointer; }

/* ===== Style presets ("gallery") — switch by changing the class ===== */

/* 1) Pill (default): bold, white card */
.dp-pill{ background:#fff; border-color:#cfd6e3; }

/* 2) Underline: minimal, large text */
.dp-underline{
  border:0; border-bottom:2px solid #cfd6e3; border-radius:0;
  background:transparent; padding-left:0; padding-right:40px;
  box-shadow:none;
}
.dp-underline:focus{ border-bottom-color:#0ea5e9; box-shadow:none; }

/* 3) Glass: translucent on dark headers */
.dp-glass{
  background: rgba(255,255,255,.08);
  color:#e5e7eb;
  border:1px solid rgba(255,255,255,.22);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 6px 18px rgba(0,0,0,.25);
}
.dp-glass::placeholder{ color:#cbd5e1; }
.dp-glass:focus{ border-color:#7dd3fc; box-shadow:0 0 0 3px rgba(125,211,252,.25); }

/* Mobile: give the date picker more room, stack button under it */
@media (max-width: 640px){
  .siteHeader{
    grid-template-columns: 1fr; grid-auto-rows: auto;
    grid-row-gap: 8px;
  }
  .hdrLeft{ justify-self: start; }
  .hdrCenter{ justify-self: stretch; }
  .hdrRight{ justify-self: end; }
  .datePicker{ height:56px; font-size:18px; }
}
 
/* Make the entire pill area clickable */
.dateWrap{
  width:100%;
  cursor:pointer;
}
.dateWrap:focus-within .datePicker{
  border-color:#0ea5e9;
  box-shadow:0 0 0 3px rgba(14,165,233,.25);
}

/* Ensure input fills the wrapper so clicks anywhere register */
.datePicker{
  width:100%;
  display:block;
}

/* Make the whole pill open the native date picker */
.datePicker{ 
  position: relative;          /* needed to anchor the indicator overlay */
  width: 100%;
  display: block;
}

/* Stretch the native calendar indicator to cover the whole input (Chrome/Edge/Safari) */
.datePicker::-webkit-calendar-picker-indicator{
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 100%;
  margin: 0;
  padding: 0;
  background: transparent;     /* keep your custom SVG background visible */
  color: transparent;          /* hide default icon */
  opacity: 0;                  /* visually invisible… */
  cursor: pointer;             /* …but click-through */
}

/* Ensure clicks anywhere don’t get blocked by other input pseudo-elements */
.datePicker::-webkit-inner-spin-button,
.datePicker::-webkit-clear-button {
  display: none;
}

/* Wrapper so the whole pill is clickable */
.dateWrap{
  position: relative;
  width: 100%;
  cursor: pointer;
}

/* The visible formatted date text */
.dateDisplay{
  position: absolute;
  left: 16px; right: 52px; top: 0; bottom: 0;
  display: flex; align-items: center;
  font: 700 18px/1 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #0b1320;
  pointer-events: none;              /* clicks go to the input */
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* Your pill input (keeps native picker, hides native text) */
.datePicker{
  width: 100%;
  height: 56px;
  border-radius: 16px;
  border: 1px solid #cfd6e3;
  background: #494949;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
  padding: 0 52px 0 16px;
  outline: none;
  font: 700 18px/56px 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

  /* hide the input's own date text so only the overlay shows */
  color: #fff;
  caret-color: transparent;

  /* custom calendar icon (optional, keep yours if you already set one) */
  appearance: none; -webkit-appearance: none; -moz-appearance: none;
  background-image:
    url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="%23556" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>');
  background-repeat: no-repeat;
  background-position: right 16px center;
  background-size: 22px;
}
.dateWrap:focus-within .datePicker{
  border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25);
}

/* Make the entire pill open the native picker in Chrome/Edge/Safari */
.datePicker::-webkit-calendar-picker-indicator{
  position: absolute; left: 0; top: 0; width: 100%; height: 100%;
  margin: 0; padding: 0; background: transparent; color: transparent; opacity: 0;
  cursor: pointer;
}
.datePicker::-webkit-inner-spin-button,
.datePicker::-webkit-clear-button{ display: none; }

/* --- FIX: Pinned event should sit under the sticky header on mobile --- */

/* Stop forcing absolute positioning */
#pinnedEvent { position: static; }   /* reset any earlier bad rules */

/* Correct placement on mobile */
@media (max-width: 960px){
  #pinnedEvent{
    position: sticky !important;
    top: calc(var(--header-h, 64px) + 0px); /* just below header */
    left: 0; right: 0;
    z-index: 6;                               /* above map, below header button taps */
  }
}

/* Ensure it never shows on desktop (you already had this, keep it) */
@media (min-width: 961px){
  #pinnedEvent{ display: none; }
}

/* Spacer will be managed by JS; start collapsed */
/* #Spacer{ height: 0 !important; }
*/

/* --- Mobile: pinned card scrolls with the page, under the header --- */
@media (max-width: 960px){
  /* Make sure the page can scroll */
  html, body { height: auto; overflow: auto; }

  /* If you have a full-height wrapper that locks scrolling, relax it on mobile */
  #app, #page, main { height: auto; overflow: visible; }

  /* The pinned card should be in-flow, not overlayed */
  #pinnedEvent{
    position: static !important;   /* no sticky/fixed/absolute */
    inset: auto !important;
    z-index: auto !important;
    display: block;
    margin: 8px 12px 0;            /* nice spacing under header */
  }
}

/* Desktop behavior unchanged (hide if that’s your design) */
@media (min-width: 961px){
  #pinnedEvent{ display: none; }
}

  </style>
</head>
<body>
<header class="siteHeader">
  <div class="hdrLeft">
    <h1>Time and Place</h1>
  </div>

<div class="hdrCenter">
  <label class="visuallyHidden" for="datePicker">Select date</label>
  <div class="dateWrap" id="dateWrap" role="button" aria-label="Open date picker">
    <span id="dateDisplay" class="dateDisplay">Select a date</span>
    <input type="date" id="datePicker" class="datePicker dp-pill" aria-label="Select date">
  </div>
</div>

  <div class="hdrRight">
    <a class="btnPrimary" href="submit.html">Submit an event</a>
  </div>
</header>

<!-- <div id="pinnedEvent" class="pinned hidden" aria-live="polite"></div> -->
<div id="Spacer" aria-hidden="true"></div>
<!-- keep your pinnedEvent below -->

<!-- Pinned event (mobile only) -->
<div id="pinnedEvent" class="pinned hidden" aria-live="polite"></div>


  <div class="container">
    <div id="map" style="position:fixed; inset:0;"></div>
    <aside class="panel" aria-label="Events list panel">
      <div class="filters"> 
        <div class="cats" id="catChips"></div>
      </div>
      <div class="list" id="eventsList" role="list"></div>
      <div class="footer">
  <span id="count"></span>
  <br>
  © 2025 Jake Erickson — No reuse permitted
</div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script> -->
  <!-- PapaParse for CSV -->
   <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script> 
 <!-- UMD builds (globals: window.maplibregl and window.pmtiles) -->
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pmtiles@3.0.6/dist/pmtiles.js"></script>
  <script>

// --- MapLibre + PMTiles setup ---
const TORONTO_BOUNDS = [[-79.7189,43.4307],[-78.8152,44.0834]]; // [W,S],[E,N]

// Register PMTiles protocol so style.json can use pmtiles:// URLs
const protocol = new pmtiles.Protocol();
maplibregl.addProtocol('pmtiles', protocol.tile);

// (use your real GitHub Pages URL for )
protocol.add(new pmtiles.PMTiles('https://pub-083e9ab60fc847608e085d99437174fb.r2.dev/toronto.pmtiles'));

// 1) set your target "home" view
const HOME = {
  center: [-79.39246303205854, 43.66447814738001], // [lng, lat] Queens Park
  zoom: 5,      // tweak to taste
  bearing: -15,     // your clockwise tilt
  pitch: 20
};

    // 2) make sure the map doesn't restore last state from the URL
const map = new maplibregl.Map({
  container: 'map',
  style: './style.json',
  hash: false,              // important: don't read/write #zoom/center in URL
  interactive: true,        // normal interactions after load
  // start anywhere; we’ll animate to HOME on 'load'
  center: [-79.38, 43.65],
  zoom: 12,
  minZoom: 9,
  maxZoom:20,
  //attributionContril: true, 
  bounds: TORONTO_BOUNDS,
  maxBounds: TORONTO_BOUNDS
});

  const cacheBust = 'v=20251014a';
  fetch(`./style.json?${cacheBust}`)
    .then(r => {
      if (!r.ok) throw new Error('Failed to fetch style.json');
      return r.json();
    })
    .then(style => {
      // Safety: ensure the source points to your R2 URL
      if (style?.sources?.toronto?.url && !String(style.sources.toronto.url).startsWith('pmtiles://')) {
        console.warn('Adjusting toronto source to pmtiles:// scheme at runtime');
        style.sources.toronto.url = 'pmtiles://https://pub-083e9ab60fc847608e085d99437174fb.r2.dev/toronto.pmtiles';
      }
      map.setStyle(style);
    })
    .catch(err => console.error(err));
    
    /*
// Build the map from your MapLibre style.json (hosted in GitHub too)
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://Jakeerickson11.github.io/TorontoEvents/style.json',
  bounds: TORONTO_BOUNDS,
  maxBounds: TORONTO_BOUNDS,
  minZoom: 12,
  maxZoom: 19,
  attributionControl: true,
  bearing: 0
});
*/
   
    
let markers = []; // replaces Leaflet markersLayer

// (optional) zoom control; we'll hide it on mobile via CSS
map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'top-left');

// Keep map responsive
//window.addEventListener('resize', () => map.resize());

 //Force a visible attribution line with your credits
// Remove an existing attribution control if you already added one
// (skip if you don't have one)
// map._controls?.forEach(c => c instanceof maplibregl.AttributionControl && map.removeControl(c));

map.addControl(
  new maplibregl.AttributionControl({
    // This makes a small "i" button on small screens that expands on tap
    compact: true,
    // Add your own source credit(s) as hyperlinks
    customAttribution: [
      '© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors',
      '<a href="https://protomaps.com/pmtiles" target="_blank" rel="noopener">PMTiles</a>',
      // add/remove as needed:
      // '<a href="https://yourdomain.com/attribution" target="_blank" rel="noopener">Toronto Events Map</a>'
    ].join(' • ')
  }),
  'bottom-right'
);

    
// 📍 control
let geoWatchId = null;
let userCenteredOnce = false;
let userFirstFixNotified = false;
let userAccuracy = null;

class LocateControl {
  onAdd(m){
    this._map = m;
    const wrap = document.createElement('div');
    wrap.className = 'maplibregl-ctrl maplibregl-ctrl-group';
    const btn = document.createElement('button');
    btn.className = 'meCtrl';
    btn.type = 'button';
    btn.title = 'Show my location';
    btn.textContent = 'me';
    btn.onclick = () => toggleGeolocation(btn);
    wrap.appendChild(btn);
    this._btn = btn;
    return wrap;
  }
  onRemove(){
    this._btn.onclick = null;
  }
}
map.addControl(new LocateControl(), 'top-left');

// user marker (DOM)
let userMarker = null;
function makeMeEl(){
  const b = document.createElement('div');
  b.style.cssText =
    'width:20px;height:20px;border-radius:999px;background:#0ea5e9;color:#fff;' +
    'display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;' +
    'border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25);text-transform:uppercase;';
  b.textContent = 'me';
  return b;
}

function toggleGeolocation(btn){
  if (!('geolocation' in navigator)) {
    alert('Geolocation is not supported on this device/browser.');
    return;
  }
  if (geoWatchId){
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
    if (userMarker){ userMarker.remove(); userMarker = null; }
    userCenteredOnce = false; userFirstFixNotified = false;
    if (btn) btn.style.filter = ''; // clear active look
    if (typeof render === 'function') render();
    if (typeof renderPinned === 'function') renderPinned();
    return;
  }
  userCenteredOnce = false; userFirstFixNotified = false;
  if (btn) btn.style.filter = 'brightness(0.95)'; // simple active state
  geoWatchId = navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, {
    enableHighAccuracy:true, maximumAge:10000, timeout:10000
  });
}

function onGeoSuccess(pos){
  const { latitude:lat, longitude:lng } = pos.coords;

  if (!userMarker){
    userMarker = new maplibregl.Marker({ element: makeMeEl() })
      .setLngLat([lng,lat]).addTo(map);
  } else {
    userMarker.setLngLat([lng,lat]);
  }
/*
  // pan once if off-screen (no zoom snap)
  if (!userCenteredOnce){
    if (!map.getBounds().contains([lng,lat])){
      map.panTo([lng,lat], { duration: 500 });
    }
    userCenteredOnce = true;
  }
*/
  if (!userFirstFixNotified){
    if (typeof render === 'function') render();
    if (typeof renderPinned === 'function') renderPinned();
    userFirstFixNotified = true;
  }
}

function onGeoError(err){
  console.warn('Geolocation error:', err);
  alert('Could not get your location: ' + (err && err.message ? err.message : 'unknown error'));
  if (typeof render === 'function') render();
  if (typeof renderPinned === 'function') renderPinned();
}

    // Central spot 
const HOME_CENTER = [-79.39541111220227, 43.651913160209645]; // [lng, lat]
// Choose zoom, bearing, pitch per device
function homeView(){
  if (isMobile()) {
    return { center: HOME_CENTER, zoom: 11, bearing: 10, pitch: 0 };
  } else {
    return { center: HOME_CENTER, zoom: 11, bearing: 10, pitch: 0 };
  }
}


window.addEventListener('resize', () => map.resize());
    
// Apply a dark, monotone palette to the current MapLibre style.
// Hides non-road labels; keeps only road names.
 // 3) on first paint, animate to your exact home view
    map.on('load', () => {
  // use jumpTo first to avoid the "double pan then rotate" look (optional)
  map.jumpTo({ center: HOME.center, zoom: 10, bearing: 5, pitch: 0 });
  const hv = homeView();
  // then do a smooth, deliberate rotate/zoom if you like
  map.easeTo({
    center: HOME.center,
    zoom: 11,
    bearing: -15,
    pitch: 20,
    //offset: OPENING_OFFSET,   // remove if you don't have a sidebar
    duration: 1200,           // 1.2s feels nice
    essential: true
  });

    
 //map.on('load', () => {
   /* map.fitBounds(TORONTO_BOUNDS, {
    padding: { top: 80, right: 80, bottom: 80, left: 320 },
    duration: 0 // instant fit so the next animation feels deliberate
  });
     map.easeTo({
    bearing: -15,
    pitch: 10,         // uncomment if you want a bit of tilt
    //zoom: map.getZoom(), // keep current zoom
    duration: 1200       // 1.2s feels nice
  });
*/
  const layers = (map.getStyle() && map.getStyle().layers) || [];

  const safePaint = (id, prop, val) => { try { map.setPaintProperty(id, prop, val); } catch(_){} };
  const safeLayout = (id, prop, val) => { try { map.setLayoutProperty(id, prop, val); } catch(_){} };

  layers.forEach(l => {
    const id = (l.id || '').toLowerCase();
    const t  = l.type;
/*
    if (t === 'background') {
      safePaint(l.id, 'background-color', '#0b1320'); // deep navy
      return;
    }

    if (t === 'fill') {
      const isWater   = id.includes('water');
      const isPark    = id.includes('park') || id.includes('green') || id.includes('landuse');
      const base      = isWater ? '#0a1625' : (isPark ? '#0e2139' : '#0f172a');
      safePaint(l.id, 'fill-color', base);
      safePaint(l.id, 'fill-opacity', 1);
      return;
    }

    if (t === 'line') {
      const isBoundary = id.includes('boundary');
      const isRoad     = id.includes('road') || id.includes('highway') || id.includes('transport');
      const col        = isBoundary ? '#22304a' : (isRoad ? '#3f4a5a' : '#1f2532');
      safePaint(l.id, 'line-color', col);
      safePaint(l.id, 'line-opacity', 1);
      // optional: thinner minor roads
      if (id.includes('minor')) safePaint(l.id, 'line-width', 0.5);
      return;
    }

    if (t === 'fill-extrusion') {
      safePaint(l.id, 'fill-extrusion-color', '#111827'); // building 3D, if present
      return;
    }
*/
    if (t === 'symbol') {
      // Keep only road names; hide POI/place/transit/etc.
      const isRoadLabel = id.includes('road') || id.includes('highway') || id.includes('street') || id.includes('transport');
      if (!isRoadLabel) {
        safeLayout(l.id, 'visibility', 'none');
      } else {
        safePaint(l.id, 'text-color',      '#e5e7eb'); // light grey
        safePaint(l.id, 'text-halo-color', '#0b1320'); // dark halo for contrast
        safePaint(l.id, 'text-halo-width', 1.25);
      }
      return;
    }
  });
});

// Use device-specific padding when focusing events later
function focusEvent(lng, lat){
  const padDesktop = { top: 60, right: 60, bottom: 60, left: 360 }; // sidebar + breathing room
  const padMobile  = { top: 60, right: 60, bottom: 240, left: 60 }; // extra bottom room for UI
  map.easeTo({
    center: [lng, lat],
    zoom: isMobile() ? 15 : Math.max(map.getZoom(), 14),
    padding: isMobile() ? padMobile : padDesktop,
    duration: 500
  });
}

// ===== Fast auto-hide  =====
  // …keep your other JS…

  const headerEl  = document.querySelector('.siteHeader');
  const spacerEl  = document.getElementById('Spacer');       // <— match DOM id

  function setHeaderHeightVar(){
    if (!headerEl) return;
    const h = headerEl.offsetHeight || 1;
    document.documentElement.style.setProperty('--header-h', h + 'px');
    updateSpacer(); // keep spacer in sync when header height changes
  }

  function updateSpacer(){
    if (!spacerEl) return;
    // Only reserve space on mobile when the pinned card is visible
    const onMobile = window.matchMedia('(max-width: 960px)').matches;
    if (!onMobile || !pinnedEl || pinnedEl.classList.contains('hidden')) {
      spacerEl.style.height = '0px';
      return;
    }
    // header height + pinned card outer height + its top margin (8px in your CSS)
    const headerH = headerEl ? headerEl.offsetHeight : 0;
    const pinnedH = pinnedEl.offsetHeight || 0;
    spacerEl.style.height = (headerH + pinnedH + 8) + 'px';
  }

  window.addEventListener('load',  setHeaderHeightVar);
  window.addEventListener('resize', setHeaderHeightVar);

  // After you render the pinned card, also refresh spacer height:
  const _renderPinned = renderPinned;
  window.renderPinned = function(){
    _renderPinned();
    updateSpacer();
  };


const SHOW_AT_TOP = 0;
const HIDE_AFTER  = 80; // px


// Hide on scroll down, show on scroll up (more sensitive + rAF for smoothness)
let lastY = window.scrollY, ticking = false;
const MIN_DELTA = 4;  // smaller = quicker reaction

window.addEventListener('scroll', () => {
  const y = Math.max(0, window.scrollY);
  const delta = y - lastY;

  if (y <= SHOW_AT_TOP || delta < -MIN_DELTA) {
    // scrolling up (or at top): show header
    document.body.classList.remove('header-hidden');
  } else if (delta > MIN_DELTA && y > HIDE_AFTER) {
    // scrolling down: hide header
    document.body.classList.add('header-hidden');
  }

  lastY = y;
}, { passive: true });
                    

    // One-off events (existing sheet)
    const GOOGLE_SHEET_CSV_URL =
      "https://bitter-sun-0e27.jakeerickson11.workers.dev/events";

    // NEW: weekly/recurring events (publish this sheet to CSV and paste the link)
    const WEEKLY_SHEET_CSV_URL =
      "https://bitter-sun-0e27.jakeerickson11.workers.dev/weekly";

    // How far to expand weekly events (today → today+N days)
    const RECUR_WINDOW_DAYS = 90;

    const CATEGORY_COLORS = {
      "Trivia": getCSS('--cat-active'),
      "Live Music": getCSS('--cat-creative'),
      "Open Mic": getCSS('--cat-entertain'),
      "Karaoke": getCSS('--cat-competitive'),
      "Relaxing & Romantic": getCSS('--cat-relax')
    };

    function categoryColor(cat){
  return CATEGORY_COLORS[cat] || '#64748b'; // fallback for unknown categories
}



    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    // const markersLayer = L.layerGroup().addTo(map);
    const datePicker = document.getElementById('datePicker');
    const catChips  = document.getElementById('catChips');
    const listEl    = document.getElementById('eventsList');
    const countEl   = document.getElementById('count');
    

    const pinnedEl  = document.getElementById('pinnedEvent');
let pinnedEvent = null;

function isMobile(){ return window.matchMedia('(max-width: 960px)').matches; }

function setPinned(ev){
  pinnedEvent = ev;
  renderPinned();
}

function renderPinned(){
  if(!pinnedEl) return;

  if(pinnedEvent && isMobile()){
    const color = CATEGORY_COLORS[pinnedEvent.category] || '#888';

    // Build a Google Maps directions URL if user location is active
    let dirUrl = '';
    try {
      if (typeof userMarker !== 'undefined' && userMarker && userMarker.getLatLng){
        const u = userMarker.getLngLat(); // {lng, lat}
        if (Number.isFinite(pinnedEvent.lat) && Number.isFinite(pinnedEvent.lng)) {
          // Use lat/lng if available
          dirUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(`${u.lat},${u.lng}`)}&destination=${encodeURIComponent(`${pinnedEvent.lat},${pinnedEvent.lng}`)}&travelmode=driving`;
        } else {
          // Fallback to address/venue/name
          const destText = pinnedEvent.address || pinnedEvent.venue || pinnedEvent.name || '';
          if (destText){
            dirUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(`${u.lat},${u.lng}`)}&destination=${encodeURIComponent(destText)}&travelmode=driving`;
          }
        }
      }
    } catch(_) {}

    const directionsBtn = dirUrl ? `<a class="dirBtn" href="${dirUrl}" target="_blank" rel="noopener">Directions</a>` : '';

    pinnedEl.classList.remove('hidden');
    pinnedEl.innerHTML = `
      <div class="pinnedCard">
        <button id="pinnedClear" class="pinnedClear" aria-label="Clear pinned event" title="Clear">×</button>
        <img class="thumb" src="${pinnedEvent.photo || 'https://placehold.co/200x200?text=Photo'}" alt="${safe(pinnedEvent.name||'event')}">
        <div>
          <div class="pinnedTitle">${safe(pinnedEvent.name)}</div>
          <div class="pinnedMeta">${safe(pinnedEvent.venue || pinnedEvent.address || '')}</div>
          <div class="pinnedMeta">${safe(pinnedEvent.date)} ${pinnedEvent.time?`• ${safe(pinnedEvent.time)}`:''}</div>
          <div class="pinnedMeta"><a href="${pinnedEvent.link}" target="_blank" rel="noopener">Event page</a></div>
          <div style="margin-top:6px">
            <span class="pinnedBadge"><span class="dot" style="background:${color}"></span>${safe(pinnedEvent.category||'')}</span>
          </div>
          ${directionsBtn ? `<div class="pinnedActions">${directionsBtn}</div>` : ``}
        </div>
      </div>
    `;

    // Wire the clear (×) button
    const btn = document.getElementById('pinnedClear');
    if (btn) btn.addEventListener('click', clearPinned);

  } else {
    pinnedEl.classList.add('hidden');
    pinnedEl.innerHTML = '';
  }
}

function clearPinned(){
  pinnedEvent = null;
  renderPinned();
}

window.addEventListener('resize', renderPinned); // keep it correct on rotate/resize

    // ----- Date helpers -----
    function isoLocal(d){ const off=d.getTimezoneOffset()*60000; return new Date(d.getTime()-off).toISOString().slice(0,10); }
    
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function monthKey(d){ return d.getFullYear()*12 + d.getMonth(); } // for incrementing months




function weekdayOrdinalInMonth(d){
  // e.g., d = 2025-10-14 (Tue) → returns 2 (2nd Tuesday)
  const day = d.getDate();
  return Math.floor((day - 1) / 7) + 1; // 1..5
}

function nthWeekdayOfMonth(year, monthIndex, weekday, nth){
  // weekday: 0=Sun … 6=Sat, nth: 1..5 (5 may not exist every month)
  const firstOfMonth = new Date(year, monthIndex, 1);
  const delta = (weekday - firstOfMonth.getDay() + 7) % 7;
  const firstTarget = 1 + delta;      // date of first desired weekday
  const date = firstTarget + (nth - 1) * 7;
  const result = new Date(year, monthIndex, date);
  if (result.getMonth() !== monthIndex) return null; // overflow → no such nth this month
  return result;
}
    
    function normalizeDate(str){
      if(!str) return '';
      const s=String(str).trim();
      const hy=s.split('-');
      if(hy.length===3 && hy[0].length===4){ const y=+hy[0], m=+hy[1], d=+hy[2]; if(m>=1&&m<=12&&d>=1&&d<=31){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; } }
      const sl=s.split('/');
      if(sl.length===3){ let a=+sl[0], b=+sl[1], y=+sl[2]; let m,d; if(a>12){ d=a; m=b; } else { m=a; d=b; } if(m>=1&&m<=12&&d>=1&&d<=31){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; } }
      const dt=new Date(s); if(!isNaN(dt)) return isoLocal(dt);
      return s;
    }
    function addDays(d, n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }
    function clampDateRange(start, end){
      // Optional: clamp by Start/End in weekly rows
      return {start: new Date(start), end: new Date(end)};
    }
    function parseCoordsToLatLng(val){
  const s = String(val || '').trim();
  // find first two numbers that look like coordinates, in order
  const m = s.match(/(-?\d+(?:\.\d+)?)[^\d-]+(-?\d+(?:\.\d+)?)/);
  if (!m) return { lat: null, lng: null };
  return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
}

    // Parse weekday strings/numbers to 0–6 (Sun=0)
    const DOW_MAP = { sun:0, sunday:0, mon:1, monday:1, tue:2, tues:2, tuesday:2,
      wed:3, weds:3, wednesday:3, thu:4, thur:4, thurs:4, thursday:4, fri:5, friday:5, sat:6, saturday:6 };
    function parseDOW(val){
      if(val==null) return null;
      const s=String(val).trim().toLowerCase();
      if(s==='' ) return null;
      if(/^\d$/.test(s)){ const n=+s; return (n>=0 && n<=6) ? n : null; }
      return (s in DOW_MAP) ? DOW_MAP[s] : null;
    }

    let allEvents = [];
    let activeCats = new Set(Object.keys(CATEGORY_COLORS));

function buildCategoryChips(){
  // Build chips from whatever categories actually exist in the merged data
  const catsFromData = Array.from(new Set(
    allEvents.map(e => (e.category || 'Other').trim())
  )).sort();

  // Start with all categories ON
  activeCats = new Set(catsFromData);

  catChips.innerHTML = '';
  catsFromData.forEach(cat => {
    const color = categoryColor(cat);
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.setAttribute('data-cat', cat);
    chip.innerHTML = `<span class="dot" style="background:${color}"></span>${cat}`;
    chip.onclick = () => {
      if (activeCats.has(cat)) activeCats.delete(cat); else activeCats.add(cat);
      chip.style.opacity = activeCats.has(cat) ? 1 : 0.4;
      render();
    };
    catChips.appendChild(chip);
  });
}

    // Promise wrapper for Papa.parse (CSV -> rows)
    function loadCSV(url){
      return new Promise((resolve, reject) => {
        if(!url) return resolve([]);
        Papa.parse(url, {
          download: true, header: true, skipEmptyLines: true,
          complete: (res) => resolve(res.data || []),
          error: reject
        });
      });
    }

    // Cleaners for both sheets
 function cleanOneOff(r){
  const coordsField = r["Coords"] || r["Coordinates"] || r["Lat/Lng"] || r["Location"] || '';

  let lat = parseFloat(r["Lat"]);
  let lng = parseFloat(r["Lng"]);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    const c = parseCoordsToLatLng(coordsField);
    lat = Number.isFinite(c.lat) ? c.lat : null;
    lng = Number.isFinite(c.lng) ? c.lng : null;
  }

  return {
    name: (r["Event name"] || r.name || '').trim(),
    venue: (r["Venue"] || r.venue || '').trim(),
    date: normalizeDate((r["Date"] || r.date || '').trim()),
    time: (r["Time"] || r.time || '').trim(),
    category: (r["Category"] || r.category || '').trim(),
    link: (r["Link"] || r.link || '').trim(),
    address: (r["Address"] || r.address || '').trim(),
    photo: (r["Photo"] || r.photo || '').trim(),
    lat, lng,
    promoted: truthy(getField(r, ['Promoted','promoted'])),  // ← simple & global
    __source: 'oneoff'
  };
}

// Interprets 1 / true / yes / y (case-insensitive) as true
function truthy(v){
  return /^(1|true|yes|y)$/i.test(String(v || '').trim());
}

// Gets a field from a row by exact key, common variants, or case/space-insensitive header
function getField(row, candidates){
  // fast path: exact names
  for (var i=0;i<candidates.length;i++){
    var k = candidates[i];
    if (row != null && Object.prototype.hasOwnProperty.call(row, k)) return row[k];
  }
  // tolerant path: trim + lowercase header names (handles " Promoted ", "PROMOTED", etc.)
  var want = candidates.map(function(n){ return String(n).replace(/\s+/g,'').toLowerCase(); });
  for (var key in row){
    var norm = String(key).replace(/\s+/g,'').toLowerCase();
    if (want.indexOf(norm) !== -1) return row[key];
  }
  return '';
}


function cleanWeekly(r){
  const dowRaw = r["Day"] ?? r["Weekday"] ?? r["weekday"] ?? r["day"];
  const startRaw = normalizeDate((r["Start"] || r["start"] || '').trim());
  const endRaw   = normalizeDate((r["End"]   || r["end"]   || '').trim());
  const excludes = String(r["Exclude Dates"] || r["Exclude"] || '')
                    .split(',').map(s=>normalizeDate(s.trim())).filter(Boolean);

  const coordsField = r["Coords"] || r["Coordinates"] || r["Lat/Lng"] || r["Location"] || '';
  let lat = parseFloat(r["Lat"]); let lng = parseFloat(r["Lng"]);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    const c = parseCoordsToLatLng(coordsField);
    lat = Number.isFinite(c.lat) ? c.lat : null;
    lng = Number.isFinite(c.lng) ? c.lng : null;
  }

  const raw = (r["Repeat"] ?? r["Frequency"] ?? "").toString().toLowerCase().trim();
  const norm = raw.replace(/[\s-_/]/g, '');
  let repeat = 'weekly';
  if (['biweekly','2w','fortnightly','everyotherweek','q2w'].includes(norm)) repeat = 'biweekly';
  else if (['monthly','1m','monthlynth','nthmonthly'].includes(norm)) repeat = 'monthly';

  return {
    name: (r["Event name"] || r.name || '').trim(),
    venue: (r["Venue"] || r.venue || '').trim(),
    day: parseDOW(dowRaw),
    time: (r["Time"] || r.time || '').trim(),
    category: (r["Category"] || r.category || '').trim(),
    link: (r["Link"] || r.link || '').trim(),
    address: (r["Address"] || r.address || '').trim(),
    photo: (r["Photo"] || r.photo || '').trim(),
    lat, lng,
    start: startRaw,
    end: endRaw,
    excludes,
    repeat,
    promoted: truthy(getField(r, ['Promoted','promoted'])),  // ← simple & global
    __source: 'weekly'
  };
}


    // Expand weekly rows into dated event instances within [rangeStart, rangeEnd]
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }
function isoLocal(d){ const off=d.getTimezoneOffset()*60000; return new Date(d.getTime()-off).toISOString().slice(0,10); }
function weekdayOrdinalInMonth(d){ return Math.floor((d.getDate()-1)/7)+1; }
function nthWeekdayOfMonth(year, monthIndex, weekday, nth){
  const first = new Date(year, monthIndex, 1);
  const delta = (weekday - first.getDay() + 7) % 7;
  const date = 1 + delta + (nth-1)*7;
  const res = new Date(year, monthIndex, date);
  return res.getMonth() === monthIndex ? res : null;
}

//////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////



function expandWeekly(row, rangeStart, rangeEnd){
  const out = [];
  if (row.day == null) return out;

  const hardStart = row.start ? startOfDay(new Date(row.start)) : null;
  const hardEnd   = row.end   ? startOfDay(new Date(row.end))   : null;

  let effStart = startOfDay(rangeStart);
  let effEnd   = startOfDay(rangeEnd);
  if (hardStart && hardStart > effStart) effStart = hardStart;
  if (hardEnd && hardEnd < effEnd)       effEnd   = hardEnd;

  const excludes = new Set((row.excludes || []).filter(Boolean));

  // ----- WEEKLY / BIWEEKLY -----
  if (row.repeat === 'weekly' || row.repeat === 'biweekly'){
    const anchorBase = hardStart || effStart;
    const first = new Date(anchorBase);
    const delta = (row.day - first.getDay() + 7) % 7;
    first.setDate(first.getDate() + delta);

    const step = (row.repeat === 'biweekly') ? 14 : 7;

    // If the first anchor is still before effStart, advance by whole steps to preserve phase
    let d = new Date(first);
    while (d < effStart) d = addDays(d, step);

    for (; d <= effEnd; d = addDays(d, step)){
      const iso = isoLocal(d);
      if (!excludes.has(iso)){
        out.push({
          name: row.name, venue: row.venue, date: iso, time: row.time,
          category: row.category, link: row.link, address: row.address,
          photo: row.photo, lat: row.lat, lng: row.lng,
          promoted: row.promoted, 
          __source: 'weekly'
        });
      }
    }
    return out;
  }

  // ----- MONTHLY (nth weekday anchored by Start/first match) -----
  if (row.repeat === 'monthly'){
    const base = hardStart || effStart;
    const first = new Date(base);
    const delta = (row.day - first.getDay() + 7) % 7;
    first.setDate(first.getDate() + delta);
    const nth = weekdayOrdinalInMonth(first);

    let y = first.getFullYear(), m = first.getMonth();
    // advance to first >= effStart
    while (true){
      const c = nthWeekdayOfMonth(y, m, row.day, nth);
      if (c && c >= effStart) break;
      m++; if (m>11){ m=0; y++; }
      if (new Date(y, m, 1) > effEnd) return out;
    }
    // collect until effEnd
    while (true){
      const d = nthWeekdayOfMonth(y, m, row.day, nth);
      if (!d) { m++; if (m>11){ m=0; y++; } if (new Date(y, m, 1) > effEnd) break; continue; }
      if (d > effEnd) break;
      const iso = isoLocal(d);
      if (!excludes.has(iso)){
        out.push({
          name: row.name, venue: row.venue, date: iso, time: row.time,
          category: row.category, link: row.link, address: row.address,
          photo: row.photo, lat: row.lat, lng: row.lng,
          promoted: row.promoted, 
          __source: 'weekly'
        });
      }
      m++; if (m>11){ m=0; y++; }
    }
    return out;
  }

  // Fallback
  return expandWeekly({...row, repeat:'weekly'}, rangeStart, rangeEnd);
}


    // Load both sheets, expand weekly, merge, then render
    async function loadAll(){
  try{
    const [oneOffRaw, weeklyRaw] = await Promise.all([
      loadCSV(GOOGLE_SHEET_CSV_URL),
      loadCSV(WEEKLY_SHEET_CSV_URL)
    ]);

    const oneOff = (oneOffRaw || []).map(cleanOneOff).filter(r => r.name && r.date);
    const weekly = (weeklyRaw || []).map(cleanWeekly).filter(r => r.name && r.day != null);

    // Determine expansion window (today → today+RECUR_WINDOW_DAYS)
    const today = new Date();
    const rangeStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // midnight local
    const rangeEnd   = addDays(rangeStart, RECUR_WINDOW_DAYS);

    const weeklyExpanded = weekly.flatMap(r => expandWeekly(r, rangeStart, rangeEnd));

    // Merge and normalize dates
    allEvents = [...oneOff, ...weeklyExpanded]
      .map(e => ({ ...e, date: normalizeDate(e.date) }))
      .filter(e => e.date);

    buildCategoryChips();

// Build calendar bounds from merged dates and pick a safe default date
const dates = Array.from(new Set(allEvents.map(r => r.date))).sort();
const todayStr = isoLocal(new Date());

if (datePicker) {
  if (dates.length) {
    datePicker.min   = dates[0];
    datePicker.max   = dates[dates.length - 1];
    datePicker.value = dates.includes(todayStr) ? todayStr : dates[0];
  } else {
    datePicker.min = todayStr;
    datePicker.max = todayStr;
    datePicker.value = todayStr;
  }
} // if there’s no datePicker for some reason, we just show all dates

(function(){
  const dp = document.getElementById('datePicker');
  const dd = document.getElementById('dateDisplay');
  if (!dp || !dd) return;

  // Format like: Monday, October 13, 2025 (uses user locale by default)
  const fmt = new Intl.DateTimeFormat(undefined, {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });

  function updateDateDisplay(){
    if (dp.value) {
      // Ensure consistent parsing (local midnight)
      const d = new Date(dp.value + 'T00:00:00');
      dd.textContent = fmt.format(d);
    } else {
      dd.textContent = 'Select a date';
    }
  }

  // Update on load and when the date changes
  updateDateDisplay();
  dp.addEventListener('change', () => {
    updateDateDisplay();
    if (typeof render === 'function') render();   // keep your app behavior
  });

  // Optional: if you programmatically set dp.value elsewhere, call updateDateDisplay() after.
})();

render();

  } catch(err){
    console.error('CSV load error', err);
    alert('Could not load one or both CSVs. Please make sure both sheets are published to the web as CSV.');
  }
}



    // userMarker must be the one you create in your geolocation code
function hasUserLocation(){
  return !!(userMarker && typeof userMarker.getLngLat === 'function');
}


function gmapsDirectionsURL(oLat, oLng, dLat, dLng, mode='driving'){
  const origin = `${oLat},${oLng}`;
  const dest   = `${dLat},${dLng}`;
  return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=${encodeURIComponent(mode)}`;
}

// Fallback if an event is missing lat/lng: use address/venue/name
function gmapsDirectionsURLFallback(oLat, oLng, ev){
  if (Number.isFinite(ev.lat) && Number.isFinite(ev.lng)){
    return gmapsDirectionsURL(oLat, oLng, ev.lat, ev.lng);
  }
  const destText = ev.address || ev.venue || ev.name || '';
  if (!destText) return '';
  const origin = `${oLat},${oLng}`;
  return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destText)}`;
}

let selectedEventKey = null; // tracks the currently-selected list item

  function render(){
  // Read date from the picker (or leave blank = show all dates)
  const chosenDate = (datePicker && datePicker.value) ? datePicker.value : '';

  const filtered = allEvents.filter(e => {
    const matchDate = chosenDate ? e.date === chosenDate : true;
    const matchCat  = activeCats.has((e.category || 'Other').trim());
    return matchDate && matchCat; // (search removed)
  });

// ——— NEW: put promoted first (stable order within each group)
const isPromoted = (ev) => !!ev.promoted || /^(1|true|yes|y)$/i.test(String(ev.Promoted||'').trim());
const ordered = [
  ...filtered.filter(isPromoted),
  ...filtered.filter(ev => !isPromoted(ev))
];


      // remove old markers
// remove old markers
markers.forEach(m => m.remove());
markers = [];

// Build bounds
const bounds = new maplibregl.LngLatBounds();
let havePts = false;

ordered.forEach(function(e, i){
  if (!Number.isFinite(e.lat) || !Number.isFinite(e.lng)) return;

  // Guard against missing globals so we never throw
  var color = (typeof CATEGORY_COLORS !== 'undefined' && CATEGORY_COLORS[e.category])
    ? CATEGORY_COLORS[e.category]
    : '#888';

  var _safe = (typeof safe === 'function')
    ? safe
    : function(s){ return String(s||'').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); };

  // Promoted flag accepted from either Promoted or promoted column (TRUE/Yes/1/Y)
 var promoted = !!e.promoted;

  var el = document.createElement('div');
  el.className = [
    'eventMarker',
    'eventMarker--round',
    'eventMarker--ghost',
    'eventMarker--thin'      // 👈 fix casing
  ].join(' ');
  el.style.background = color;                 // keep your original fill
  el.style.setProperty('--marker-color', color); // lets CSS glow match the fill

  if (promoted){
    el.className += ' eventMarker--promoted is-promoted';
    var badge = document.createElement('span');
    badge.className = 'eventMarker__badge';
    badge.textContent = '★';
    badge.setAttribute('aria-hidden','true');
    el.appendChild(badge);
  }

  // create marker + popup
  var marker = new maplibregl.Marker({ element: el })
    .setLngLat([e.lng, e.lat])
    .setPopup(
      new maplibregl.Popup({ offset: 12 }).setHTML(
        '<strong>' + _safe(e.name) + '</strong>' +
        (promoted ? ' <span style="font-size:12px;padding:2px 6px;border:1px solid #111;border-radius:999px;background:#fff;color:#111;vertical-align:middle;">Promoted</span>' : '') +
        '<br>' + _safe(e.venue || '') + (e.time ? ' • ' + _safe(e.time) : '') +
        '<br><a href="' + e.link + '" target="_blank" rel="noopener">Event page</a>'
      )
    )
    .addTo(map);

  // click behavior (mobile pins = pin card, desktop = highlight list)
  el.addEventListener('click', function(){
    if (typeof isMobile === 'function' ? isMobile() : window.matchMedia('(max-width: 960px)').matches){
      if (typeof setPinned === 'function') setPinned(e);
    } else {
      if (typeof highlightCard === 'function') highlightCard(i);
    }
  });

  
  // optional selected styling, safe to keep
  if (marker.getPopup){
    marker.getPopup()
      .on('open', function(){ el.classList.add('is-selected'); })
      .on('close', function(){ el.classList.remove('is-selected'); });
  }

  markers.push(marker);
  bounds.extend([e.lng, e.lat]);
  havePts = true;
});


    /////////////// drive color by data-attribute (CSS above handles fill) 
    ////////BREAKS GOOGLE SHEETS 
//if (e.category) el.dataset.category = e.category;
    
////////BREAKS GOOGLE SHEETS/////////////////////////////////////////////////
// optional: mark selected when popup opens
//const marker = new maplibregl.Marker({ element: el })
//  .setLngLat([e.lng, e.lat])
//  .setPopup(new maplibregl.Popup({ offset: 12 }).setHTML(/* ... */))
//  .addTo(map);

//marker.getPopup()
 // .on('open', ()=> el.classList.add('is-selected'))
 // .on('close', ()=> el.classList.remove('is-selected'));

/////////////////////////////////////////////////////////////////////////////
   /* 
// Fit nicely (don’t over-zoom)
if (havePts) {
  map.fitBounds(bounds, { padding: 30, maxZoom: 16 });
}
*/
      listEl.innerHTML='';
      ordered.forEach((e,i) => {
        const row = document.createElement('div');
        row.className='item';
        // stable key for this event (works across filters)
const key = `${e.name || ''}|${e.date || ''}|${e.venue || ''}|${e.address || ''}`;
row.dataset.key = key;
if (selectedEventKey === key) row.classList.add('selected');

row.onclick = (ev) => {
  // If the click was on (or inside) the Directions button, do nothing here
  if (ev.target.closest('.dirBtn')) return;

  const myKey = row.dataset.key;
  const onMobile = (typeof isMobile === 'function')
    ? isMobile()
    : window.matchMedia('(max-width: 960px)').matches;

  if (onMobile) {
    // Mobile: second tap on the SAME item opens the link
    if (selectedEventKey === myKey) {
      if (e.link) window.open(e.link, '_blank', 'noopener');
      return;
    }
  } else {
    // Desktop: single-click never opens the link
    if (selectedEventKey === myKey) return;
  }

  // Select + behaviors
  selectedEventKey = myKey;
  document.querySelectorAll('.item.selected').forEach(el => el.classList.remove('selected'));
  row.classList.add('selected');

  if (Number.isFinite(e.lat) && Number.isFinite(e.lng)) {
    map.flyTo({ center:[e.lng, e.lat], zoom:15, speed:1.6, curve:1.4 });
  }
  if (onMobile && typeof setPinned === 'function') setPinned(e);
};

row.ondblclick = (ev) => {
  // Ignore double-clicks on the Directions button
  if (ev.target.closest('.dirBtn')) return;

  const onMobile = (typeof isMobile === 'function')
    ? isMobile()
    : window.matchMedia('(max-width: 960px)').matches;
  if (onMobile) return;

  ev.preventDefault();
  if (e.link) window.open(e.link, '_blank', 'noopener');
};        
        // --- build one list row ---
const color = CATEGORY_COLORS[e.category] || '#888';

const stripe = document.createElement('div');
stripe.className = 'leftStripe';
stripe.style.background = color;
stripe.style.gridRow = '1 / span 2';
stripe.style.alignSelf = 'stretch';

const img = document.createElement('img');
img.className = 'thumb';
img.src = e.photo || 'https://placehold.co/200x200?text=Photo';
img.alt = e.name || 'event photo';

const meta = document.createElement('div');
meta.className = 'meta';

// Make the whole pill open the calendar on desktop
(function(){
  const dp = document.getElementById('datePicker');
  const wrap = document.getElementById('dateWrap');
  if (!dp || !wrap) return;

  // Click anywhere on the pill -> open native picker (Chrome/Edge support showPicker)
  wrap.addEventListener('click', (e) => {
    // If the actual input was clicked, let the browser handle it
    if (e.target === dp) return;

    // Otherwise programmatically open it
    if (typeof dp.showPicker === 'function') {
      dp.showPicker();                // best UX in Chromium
    } else {
      dp.focus();                     // fallback focuses input (Safari/Firefox)
      // Optional nudge: open keyboard on mobile
      // dp.click(); // uncomment if you want an extra poke in some browsers
    }
  });

  // Keyboard support when wrapper is focused (accessibility)
  wrap.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      if (typeof dp.showPicker === 'function') dp.showPicker(); else dp.focus();
    }
  });
})();




// Build a Google Maps directions link if user location is available
let dirUrl = '';
if (hasUserLocation()){
  const u = userMarker.getLngLat(); // {lng, lat}
  dirUrl = gmapsDirectionsURLFallback(u.lat, u.lng, e);
}
const dirLink = dirUrl
  ? `<div class="sub"><a class="dirBtn" href="${dirUrl}" target="_blank" rel="noopener">Directions</a></div>`
  : '';

const promoted = !!e.promoted || /^(1|true|yes|y)$/i.test(String(e.Promoted||'').trim());
const promotedTag = promoted ? `<span class="promotedTag" aria-label="Promoted"><span class="star">★</span> Promoted</span>` : '';

// Mobile: title + badge on one line; Desktop: original layout
if (typeof isMobile === 'function' ? isMobile() : window.matchMedia('(max-width: 960px)').matches) {
 meta.innerHTML = `
  <div class="titleRow">
    <div class="title">${safe(e.name)}</div>
    ${promotedTag}
    <span class="badge"><span class="dot" style="background:${color}"></span>${safe(e.category||'')}</span>
  </div>
  <div class="sub">${safe(e.venue || e.address || '')}</div>
  ${e.time ? `<div class="sub">${safe(e.time)}</div>` : ``}
  ${dirLink || ``}
`;


} else {
  // DESKTOP (no "Event page" link here)
meta.innerHTML = `
  <div class="title">${safe(e.name)}</div>
  <div class="sub">${safe(e.venue || e.address || '')}</div>
  ${e.time ? `<div class="sub">${safe(e.time)}</div>` : ``}
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    ${promotedTag}
    <span class="badge"><span class="dot" style="background:${color}"></span>${safe(e.category||'')}</span>
  </div>
  ${dirLink || ``}
`;
}

// Prevent row handlers from firing when clicking Directions
const dirBtnEl = meta.querySelector('.dirBtn');
if (dirBtnEl) {
  dirBtnEl.addEventListener('click', (ev) => {
    ev.stopPropagation();     // don't bubble to the row
    // open explicitly so we can also preventDefault (avoids odd behaviors)
    ev.preventDefault();
    window.open(dirBtnEl.href, '_blank', 'noopener');
  });
  // Also suppress dblclick bubbling from the button
  dirBtnEl.addEventListener('dblclick', (ev) => {
    ev.stopPropagation();
    ev.preventDefault();
  });
}

// Order content: on phones -> text left, image right; desktop -> image left, text right
const thumbWrap = document.createElement('div');
thumbWrap.appendChild(img);

const rowWrap = document.createElement('div');
rowWrap.style.display = 'contents';

// Text/links left, image right (mobile AND desktop)
rowWrap.appendChild(meta);
rowWrap.appendChild(thumbWrap);


row.appendChild(stripe);
row.appendChild(rowWrap);
listEl.appendChild(row);

      });
      countEl.textContent = `${ordered.length} event${ordered.length===1?'':'s'} shown`;
    }

    function highlightCard(index){
  const cards = [...document.querySelectorAll('.item')];
  const el = cards[index];
  if(!el) return;

  // Smoothly scroll inside the list container only
  const parent = listEl; // #eventsList
  const target = el.offsetTop - (parent.clientHeight / 2) + (el.clientHeight / 2);
  parent.scrollTo({ top: Math.max(0, target), behavior: 'smooth' });

  // Pulse highlight so it stands out
  el.animate([{ background: '#0b1320' }, { background: 'transparent' }], { duration: 900 });
}

    function safe(s){ return (s||'').toString().replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

if (datePicker) {
  datePicker.addEventListener('change', () => {
    selectedDate = datePicker.value || '';           // keep fallback in sync
    if (typeof setHeaderHeightVar === 'function') setHeaderHeightVar();
    render();
  });
}

    //searchEl.addEventListener('input', () => { window.clearTimeout(window.__t); window.__t=setTimeout(render,200); });

    loadAll();
  </script>
</body>
</html>
