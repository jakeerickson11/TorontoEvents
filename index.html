<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>City Events Map</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""

    
  />
  <style>
/* ----- (same styles as your file, unchanged) ----- */
:root{
  --bg:#dde0e2;        /* off-black page background */
  --card:#ffffff;      /* white panels for contrast */
  --muted:#7a8aa0;
  --text:#e6eef7;
  --cat-active:#16a34a;
  --cat-creative:#a855f7;
  --cat-entertain:#eab308;
  --cat-competitive:#f97316;
  --cat-relax:#3b82f6;
}
*{box-sizing:border-box}
body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
/* Dark header with bright text */
header{
  padding:16px 20px;
  border-bottom:1px solid #364152; /* subtle divider */
  position:sticky; top:0;
  background:#0b0f14;            /* dark */
  color:#f8fafc;                  /* bright text */
  z-index:5;
}
header h1{ margin:0; font-size:20px; color:#f8fafc; }
header a{ color:#f8fafc; }        /* any header links/buttons */

.container{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; padding:16px}
#map{height: calc(100vh - 100px); border-radius:16px; overflow:hidden; border:1px solid #e5eaf1}
.panel{background:var(--card); border:1px solid #e5eaf1; border-radius:16px; overflow:hidden; display:flex; flex-direction:column}
.filters{padding:12px; border-bottom:1px solid #e5eaf1; display:grid; grid-template-columns: 1fr; gap:12px}
.filters .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
.filters label{font-size:12px; color:var(--muted)}
.filters input{padding:8px 10px; border-radius:10px; border:1px solid #d0d7e2; background:#ffffff; color:var(--text)}
.filters .cats{display:flex; gap:8px; flex-wrap:wrap}
.chip{display:flex; gap:6px; align-items:center; font-size:12px; border:1px solid #d0d7e2; padding:6px 8px; border-radius:999px; background:#f8fafc; color:var(--text); cursor:pointer}
.dot{width:10px; height:10px; border-radius:999px; display:inline-block}
.cal{border:1px solid #e5eaf1; border-radius:12px; padding:8px; background:#ffffff; min-height:260px}
.cal-header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
.cal-nav{display:flex; gap:6px}
.cal-btn{padding:6px 10px; border:1px solid #d0d7e2; background:#ffffff; color:var(--text); border-radius:10px; cursor:pointer}
.cal-btn:disabled{opacity:.45; cursor:not-allowed}
.cal-title{font-size:12px; color:var(--muted)}
.cal-grid{display:grid; grid-template-columns: repeat(7, 1fr); gap:4px}
.cal-wd{font-size:11px; color:#6b7280; text-align:center; padding:4px 0}
.cal-day{font-size:12px; text-align:center; padding:8px 0; border-radius:10px; border:1px solid #d0d7e2; background:#ffffff; cursor:pointer; user-select:none}
.cal-day:hover{border-color:#94a3b8}
.cal-day.out{opacity:.35; cursor:default}
.cal-day.disabled{opacity:.45; pointer-events:none}
.cal-day.selected{outline:2px solid var(--accent); outline-offset:1px}
.cal-day.hasEvents{background:#eef2ff}
.cal-legend{font-size:11px; color:#6b7280; margin-top:6px}
.list{overflow:auto; background:#ffffff}
.item{display:grid; grid-template-columns: 72px 1fr; gap:12px; padding:12px; border-bottom:1px solid #e5eaf1; cursor:pointer; background:#ffffff}
.item:hover{background:#f5f7fb}
.thumb{width:72px; height:72px; border-radius:12px; object-fit:cover; border:1px solid #e5eaf1}
.meta{display:flex; flex-direction:column; gap:4px}
.title{font-weight:600}
.sub{color:var(--muted); font-size:12px}
.badge{display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #d0d7e2; background:#ffffff}
.leftStripe{width:6px; border-radius:0 6px 6px 0}
.footer{padding:10px; font-size:12px; color:var(--muted)}
@media (max-width: 960px){
  .container{grid-template-columns:1fr;}
  /* Fallback first, then better viewport units if supported */
  #map{
    height:42vh;   /* fallback */
    height:42svh;  /* small-viewport height */
    height:42dvh;  /* dynamic viewport height (best) */
  }
}

/* Make it even shorter on very small phones */
@media (max-width: 600px){
  #map{
    height:36vh;
    height:36svh;
    height:36dvh;
  }
}
@media (max-width: 420px){
  #map{
    height:32vh;
    height:32svh;
    height:32dvh;
  }
}


    
/* Make the right panel + controls readable on white */

.list,
.filters,
.badge,
.chip { background:#ffffff; color:#0f172a; border-color:#e5eaf1; }

.panel {
  /* keep your existing panel styles */
  height: calc(100vh - 100px); /* same as .map so they line up */
}

.list {
  flex: 1;
  min-height: 0;     /* new */
  overflow: auto;    /* you already had this — leave it in */
}

    
.filters input {
  background:#ffffff; color:#0f172a; border:1px solid #d0d7e2;
}

.meta .sub,
.filters label { color:#475569; }

.item { background:#ffffff; }
.item:hover { background:#f5f7fb; }
.thumb { border-color:#e5eaf1; }

/* Keep the header subtle on off-black; optional: */
/* header { background: linear-gradient(180deg, rgba(14,17,20,0.95), rgba(14,17,20,0.85)); } */

/* Pinned event bar (shows under header on phones) */
.pinned{ margin:8px 16px 0 16px; }
.pinned.hidden{ display:none; }
.pinnedCard{
  display:grid; grid-template-columns:64px 1fr; gap:12px; align-items:center;
  background:var(--card); color:var(--text);
  border:1px solid #e5eaf1; border-radius:12px; padding:10px;
}
.pinnedCard .thumb{
  width:64px; height:64px; border-radius:10px; object-fit:cover; border:1px solid #e5eaf1;
}
.pinnedTitle{ font-weight:600; }
.pinnedMeta{ font-size:12px; color:var(--muted); }
.pinnedBadge{
  display:inline-flex; align-items:center; gap:6px; font-size:11px;
  padding:4px 8px; border-radius:999px; border:1px solid #d0d7e2; background:#ffffff;
}
.pinned .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

/* Hide the pinned bar on desktop/tablet; only show on phones */
@media (min-width: 961px){
  .pinned{ display:none; }
}

/* Clear (×) button on pinned card */
.pinnedCard { position: relative; }
.pinnedClear{
  position:absolute; top:6px; right:6px;
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px;
  border:1px solid #d0d7e2; background:#ffffff; color:#475569;
  cursor:pointer; line-height:1; font-size:16px;
}
.pinnedClear:hover{ background:#f5f7fb; }
.pinnedClear:focus{ outline:2px solid var(--accent); outline-offset:2px; }

/* Slimmer list items on phones */
@media (max-width: 960px){
  .item{
    /* text left (1fr) + small image right (auto) */
    grid-template-columns: 1fr 56px;
    gap: 8px;
    padding: 8px 10px;
  }
  .item .leftStripe{ display:none; }        /* hide the side stripe to save space */
  .thumb{ width:56px; height:56px; }        /* smaller image */
  .meta{ gap: 2px; }                        /* tighter spacing between lines */
  .title{ font-size:14px; line-height:1.2; }
  .sub{ font-size:11px; line-height:1.2; }
  /*.badge{ display:none; }                   /* optional: hide category pill to reduce height */
}

/* Slimmer list items on phones */
@media (max-width: 960px){
  .item{
    /* text left (1fr) + small image right (auto) */
    grid-template-columns: 1fr 56px;
    gap: 8px;
    padding: 8px 10px;
  }
  .item .leftStripe{ display:none; }        /* hide the side stripe to save space */
  .thumb{ width:56px; height:56px; }        /* smaller image */
  .meta{ gap: 2px; }                        /* tighter spacing between lines */
  .title{ font-size:14px; line-height:1.2; }
  .sub{ font-size:11px; line-height:1.2; }
  .badge{ display:none; }                   /* optional: hide category pill to reduce height */
}
/* Title row with inline badge on phones */
@media (max-width: 960px){
  .titleRow{
    display:flex; align-items:center; gap:6px;
    min-width:0; /* lets ellipsis work */
  }
  .title{
    font-size:14px; line-height:1.2;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    flex:1 1 auto; /* title can shrink */
  }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    font-size:10px; padding:2px 6px; border-radius:999px;
    border:1px solid #d0d7e2; background:#ffffff;
    white-space:nowrap; flex:0 0 auto; /* badge stays compact */
  }
  .badge .dot{ width:8px; height:8px; }
}


  </style>
</head>
<body>
  <header><h1>Time and Place</h1></header>

<!-- Pinned event (mobile only) -->
<div id="pinnedEvent" class="pinned hidden" aria-live="polite"></div>


  <div class="container">
    <div id="map" aria-label="Events map"></div>
    <aside class="panel" aria-label="Events list panel">
      <div class="filters">
        <label>Date
          <input id="datePicker" type="date" />
        </label>
        <label>Search
          <input id="searchInput" type="text" placeholder="Event or venue" />
        </label>
        <div class="cats" id="catChips"></div>
      </div>
      <div class="list" id="eventsList" role="list"></div>
      <div class="footer">
  <span id="count"></span>
  <br>
  © 2025 Jake Erickson — No reuse permitted
</div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Toronto-only view + monochrome basemap (Carto Positron)
    const TORONTO_BOUNDS = L.latLngBounds([[43.58, -79.65], [43.80, -79.12]]);
    const map = L.map('map', { minZoom: 10, maxZoom: 19, maxBounds: TORONTO_BOUNDS, maxBoundsViscosity: 0.9, zoomControl: true, zoomSnap: 0.5 });
    map.fitBounds(TORONTO_BOUNDS, { padding: [20, 20] });
    map.createPane('labels'); map.getPane('labels').style.zIndex = 650; map.getPane('labels').style.pointerEvents = 'none';
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20, attribution: '&copy; OpenStreetMap contributors &copy; CARTO' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 20, pane: 'labels' }).addTo(map);

window.addEventListener('resize', () => map.invalidateSize());
    
// Darken + add color to base tiles
map.getPane('tilePane').style.filter =
  'grayscale(0%) hue-rotate(348deg) saturate(800%) brightness(0.85) contrast(1.38)';

// Invert labels so they stay light on dark
map.getPane('labels').style.filter = 'brightness(1.0)';

    // One-off events (existing sheet)
    const GOOGLE_SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vT9IWLxL_UnRLjmKdpwkFdVeC9scZfML65HyqbdppY7DC54RPv0Q3bkRa5-scyNON9pVkjwsoTcTWX-/pub?gid=811741087&single=true&output=csv";

    // NEW: weekly/recurring events (publish this sheet to CSV and paste the link)
    const WEEKLY_SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKFzStHyi9c8o4WQCIIJfCMsexEDTuMTjkmZn1oZcDT9npyqTyp7f5IT0pyuShm5ADhUIYY86kOqLm/pub?gid=811741087&single=true&output=csv";

    // How far to expand weekly events (today → today+N days)
    const RECUR_WINDOW_DAYS = 90;

    const CATEGORY_COLORS = {
      "Active & Outdoors": getCSS('--cat-active'),
      "Creative": getCSS('--cat-creative'),
      "Entertainment": getCSS('--cat-entertain'),
      "Competitive & Games": getCSS('--cat-competitive'),
      "Relaxing & Romantic": getCSS('--cat-relax')
    };

    function categoryColor(cat){
  return CATEGORY_COLORS[cat] || '#64748b'; // fallback for unknown categories
}

    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    const markersLayer = L.layerGroup().addTo(map);
    const datePicker = document.getElementById('datePicker');
    const catChips  = document.getElementById('catChips');
    const listEl    = document.getElementById('eventsList');
    const countEl   = document.getElementById('count');
    const searchEl  = document.getElementById('searchInput');

    const pinnedEl  = document.getElementById('pinnedEvent');
let pinnedEvent = null;

function isMobile(){ return window.matchMedia('(max-width: 960px)').matches; }

function setPinned(ev){
  pinnedEvent = ev;
  renderPinned();
}

function renderPinned(){
  if(!pinnedEl) return;
  if(pinnedEvent && isMobile()){
    const color = CATEGORY_COLORS[pinnedEvent.category] || '#888';
    pinnedEl.classList.remove('hidden');
    pinnedEl.innerHTML = `
      <div class="pinnedCard">
        <button id="pinnedClear" class="pinnedClear" aria-label="Clear pinned event" title="Clear">×</button>
        <img class="thumb" src="${pinnedEvent.photo || 'https://placehold.co/200x200?text=Photo'}" alt="${safe(pinnedEvent.name||'event')}">
        <div>
          <div class="pinnedTitle">${safe(pinnedEvent.name)}</div>
          <div class="pinnedMeta">${safe(pinnedEvent.venue || pinnedEvent.address || '')}</div>
          <div class="pinnedMeta">${safe(pinnedEvent.date)} ${pinnedEvent.time?`• ${safe(pinnedEvent.time)}`:''}</div>
          <div class="pinnedMeta"><a href="${pinnedEvent.link}" target="_blank" rel="noopener">Event page</a></div>
          <div style="margin-top:6px">
            <span class="pinnedBadge"><span class="dot" style="background:${color}"></span>${safe(pinnedEvent.category||'')}</span>
          </div>
        </div>
      </div>`;
    // Wire up the clear button each render
    const btn = document.getElementById('pinnedClear');
    if (btn) btn.addEventListener('click', clearPinned);
  }else{
    pinnedEl.classList.add('hidden');
    pinnedEl.innerHTML = '';
  }
}


function clearPinned(){
  pinnedEvent = null;
  renderPinned();
}

window.addEventListener('resize', renderPinned); // keep it correct on rotate/resize




    // ----- Date helpers -----
    function isoLocal(d){ const off=d.getTimezoneOffset()*60000; return new Date(d.getTime()-off).toISOString().slice(0,10); }
    
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function monthKey(d){ return d.getFullYear()*12 + d.getMonth(); } // for incrementing months

function weekdayOrdinalInMonth(d){
  // e.g., d = 2025-10-14 (Tue) → returns 2 (2nd Tuesday)
  const day = d.getDate();
  return Math.floor((day - 1) / 7) + 1; // 1..5
}

function nthWeekdayOfMonth(year, monthIndex, weekday, nth){
  // weekday: 0=Sun … 6=Sat, nth: 1..5 (5 may not exist every month)
  const firstOfMonth = new Date(year, monthIndex, 1);
  const delta = (weekday - firstOfMonth.getDay() + 7) % 7;
  const firstTarget = 1 + delta;      // date of first desired weekday
  const date = firstTarget + (nth - 1) * 7;
  const result = new Date(year, monthIndex, date);
  if (result.getMonth() !== monthIndex) return null; // overflow → no such nth this month
  return result;
}
    
    function normalizeDate(str){
      if(!str) return '';
      const s=String(str).trim();
      const hy=s.split('-');
      if(hy.length===3 && hy[0].length===4){ const y=+hy[0], m=+hy[1], d=+hy[2]; if(m>=1&&m<=12&&d>=1&&d<=31){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; } }
      const sl=s.split('/');
      if(sl.length===3){ let a=+sl[0], b=+sl[1], y=+sl[2]; let m,d; if(a>12){ d=a; m=b; } else { m=a; d=b; } if(m>=1&&m<=12&&d>=1&&d<=31){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; } }
      const dt=new Date(s); if(!isNaN(dt)) return isoLocal(dt);
      return s;
    }
    function addDays(d, n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }
    function clampDateRange(start, end){
      // Optional: clamp by Start/End in weekly rows
      return {start: new Date(start), end: new Date(end)};
    }
    function parseCoordsToLatLng(val){
  const s = String(val || '').trim();
  // find first two numbers that look like coordinates, in order
  const m = s.match(/(-?\d+(?:\.\d+)?)[^\d-]+(-?\d+(?:\.\d+)?)/);
  if (!m) return { lat: null, lng: null };
  return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
}

    // Parse weekday strings/numbers to 0–6 (Sun=0)
    const DOW_MAP = { sun:0, sunday:0, mon:1, monday:1, tue:2, tues:2, tuesday:2,
      wed:3, weds:3, wednesday:3, thu:4, thur:4, thurs:4, thursday:4, fri:5, friday:5, sat:6, saturday:6 };
    function parseDOW(val){
      if(val==null) return null;
      const s=String(val).trim().toLowerCase();
      if(s==='' ) return null;
      if(/^\d$/.test(s)){ const n=+s; return (n>=0 && n<=6) ? n : null; }
      return (s in DOW_MAP) ? DOW_MAP[s] : null;
    }

    let allEvents = [];
    let activeCats = new Set(Object.keys(CATEGORY_COLORS));

function buildCategoryChips(){
  // Build chips from whatever categories actually exist in the merged data
  const catsFromData = Array.from(new Set(
    allEvents.map(e => (e.category || 'Other').trim())
  )).sort();

  // Start with all categories ON
  activeCats = new Set(catsFromData);

  catChips.innerHTML = '';
  catsFromData.forEach(cat => {
    const color = categoryColor(cat);
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.setAttribute('data-cat', cat);
    chip.innerHTML = `<span class="dot" style="background:${color}"></span>${cat}`;
    chip.onclick = () => {
      if (activeCats.has(cat)) activeCats.delete(cat); else activeCats.add(cat);
      chip.style.opacity = activeCats.has(cat) ? 1 : 0.4;
      render();
    };
    catChips.appendChild(chip);
  });
}

    // Promise wrapper for Papa.parse (CSV -> rows)
    function loadCSV(url){
      return new Promise((resolve, reject) => {
        if(!url) return resolve([]);
        Papa.parse(url, {
          download: true, header: true, skipEmptyLines: true,
          complete: (res) => resolve(res.data || []),
          error: reject
        });
      });
    }

    // Cleaners for both sheets
   function cleanOneOff(r){
  const coordsField = r["Coords"] || r["Coordinates"] || r["Lat/Lng"] || r["Location"] || '';

  let lat = parseFloat(r["Lat"]);
  let lng = parseFloat(r["Lng"]);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    const c = parseCoordsToLatLng(coordsField);
    if (Number.isFinite(c.lat) && Number.isFinite(c.lng)) {
      lat = c.lat; lng = c.lng;
    } else {
      lat = null; lng = null;
    }
  }

  return {
    name: (r["Event name"] || r.name || '').trim(),
    venue: (r["Venue"] || r.venue || '').trim(),
    date: normalizeDate((r["Date"] || r.date || '').trim()),
    time: (r["Time"] || r.time || '').trim(),
    category: (r["Category"] || r.category || '').trim(),
    link: (r["Link"] || r.link || '').trim(),
    address: (r["Address"] || r.address || '').trim(),
    photo: (r["Photo"] || r.photo || '').trim(),
    lat, lng,
    __source: 'oneoff'
  };
}

function cleanWeekly(r){
  const dowRaw = r["Day"] ?? r["Weekday"] ?? r["weekday"] ?? r["day"];
  const startRaw = normalizeDate((r["Start"] || r["start"] || '').trim());
  const endRaw   = normalizeDate((r["End"]   || r["end"]   || '').trim());
  const excludes = String(r["Exclude Dates"] || r["Exclude"] || '')
                    .split(',').map(s=>normalizeDate(s.trim())).filter(Boolean);

  // Coords parsing fallback
  const coordsField = r["Coords"] || r["Coordinates"] || r["Lat/Lng"] || r["Location"] || '';
  let lat = parseFloat(r["Lat"]); let lng = parseFloat(r["Lng"]);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
    const c = parseCoordsToLatLng(coordsField);
    lat = Number.isFinite(c.lat) ? c.lat : null;
    lng = Number.isFinite(c.lng) ? c.lng : null;
  }

  // ---- Repeat parsing (very tolerant) ----
  const raw = (r["Repeat"] ?? r["Frequency"] ?? "").toString().toLowerCase().trim();
  const norm = raw.replace(/[\s-_/]/g, ''); // remove spaces, hyphens, slashes, underscores
  let repeat = 'weekly';
  if (['biweekly','2w','fortnightly','everyotherweek','q2w'].includes(norm)) repeat = 'biweekly';
  else if (['monthly','1m','monthlynth','nthmonthly'].includes(norm)) repeat = 'monthly';

  return {
    name: (r["Event name"] || r.name || '').trim(),
    venue: (r["Venue"] || r.venue || '').trim(),
    day: parseDOW(dowRaw),                 // 0=Sun … 6=Sat
    time: (r["Time"] || r.time || '').trim(),
    category: (r["Category"] || r.category || '').trim(),
    link: (r["Link"] || r.link || '').trim(),
    address: (r["Address"] || r.address || '').trim(),
    photo: (r["Photo"] || r.photo || '').trim(),
    lat, lng,
    start: startRaw,
    end: endRaw,
    excludes,
    repeat,                                // now normalized to 'weekly' | 'biweekly' | 'monthly'
    __source: 'weekly'
  };
}


    // Expand weekly rows into dated event instances within [rangeStart, rangeEnd]
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }
function isoLocal(d){ const off=d.getTimezoneOffset()*60000; return new Date(d.getTime()-off).toISOString().slice(0,10); }
function weekdayOrdinalInMonth(d){ return Math.floor((d.getDate()-1)/7)+1; }
function nthWeekdayOfMonth(year, monthIndex, weekday, nth){
  const first = new Date(year, monthIndex, 1);
  const delta = (weekday - first.getDay() + 7) % 7;
  const date = 1 + delta + (nth-1)*7;
  const res = new Date(year, monthIndex, date);
  return res.getMonth() === monthIndex ? res : null;
}

function expandWeekly(row, rangeStart, rangeEnd){
  const out = [];
  if (row.day == null) return out;

  const hardStart = row.start ? startOfDay(new Date(row.start)) : null;
  const hardEnd   = row.end   ? startOfDay(new Date(row.end))   : null;

  let effStart = startOfDay(rangeStart);
  let effEnd   = startOfDay(rangeEnd);
  if (hardStart && hardStart > effStart) effStart = hardStart;
  if (hardEnd && hardEnd < effEnd)       effEnd   = hardEnd;

  const excludes = new Set((row.excludes || []).filter(Boolean));

  // ----- WEEKLY / BIWEEKLY -----
  if (row.repeat === 'weekly' || row.repeat === 'biweekly'){
    const anchorBase = hardStart || effStart;
    const first = new Date(anchorBase);
    const delta = (row.day - first.getDay() + 7) % 7;
    first.setDate(first.getDate() + delta);

    const step = (row.repeat === 'biweekly') ? 14 : 7;

    // If the first anchor is still before effStart, advance by whole steps to preserve phase
    let d = new Date(first);
    while (d < effStart) d = addDays(d, step);

    for (; d <= effEnd; d = addDays(d, step)){
      const iso = isoLocal(d);
      if (!excludes.has(iso)){
        out.push({
          name: row.name, venue: row.venue, date: iso, time: row.time,
          category: row.category, link: row.link, address: row.address,
          photo: row.photo, lat: row.lat, lng: row.lng, __source: 'weekly'
        });
      }
    }
    return out;
  }

  // ----- MONTHLY (nth weekday anchored by Start/first match) -----
  if (row.repeat === 'monthly'){
    const base = hardStart || effStart;
    const first = new Date(base);
    const delta = (row.day - first.getDay() + 7) % 7;
    first.setDate(first.getDate() + delta);
    const nth = weekdayOrdinalInMonth(first);

    let y = first.getFullYear(), m = first.getMonth();
    // advance to first >= effStart
    while (true){
      const c = nthWeekdayOfMonth(y, m, row.day, nth);
      if (c && c >= effStart) break;
      m++; if (m>11){ m=0; y++; }
      if (new Date(y, m, 1) > effEnd) return out;
    }
    // collect until effEnd
    while (true){
      const d = nthWeekdayOfMonth(y, m, row.day, nth);
      if (!d) { m++; if (m>11){ m=0; y++; } if (new Date(y, m, 1) > effEnd) break; continue; }
      if (d > effEnd) break;
      const iso = isoLocal(d);
      if (!excludes.has(iso)){
        out.push({
          name: row.name, venue: row.venue, date: iso, time: row.time,
          category: row.category, link: row.link, address: row.address,
          photo: row.photo, lat: row.lat, lng: row.lng, __source: 'weekly'
        });
      }
      m++; if (m>11){ m=0; y++; }
    }
    return out;
  }

  // Fallback
  return expandWeekly({...row, repeat:'weekly'}, rangeStart, rangeEnd);
}




    // Load both sheets, expand weekly, merge, then render
    async function loadAll(){
      try{
        const [oneOffRaw, weeklyRaw] = await Promise.all([
          loadCSV(GOOGLE_SHEET_CSV_URL),
          loadCSV(WEEKLY_SHEET_CSV_URL)
        ]);

        const oneOff = (oneOffRaw||[]).map(cleanOneOff).filter(r => r.name && r.date);
        const weekly = (weeklyRaw||[]).map(cleanWeekly).filter(r => r.name && r.day!=null);

        // Determine expansion window (today → today+RECUR_WINDOW_DAYS)
        const today = new Date();
        const rangeStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // midnight local
        const rangeEnd   = addDays(rangeStart, RECUR_WINDOW_DAYS);

        const weeklyExpanded = weekly.flatMap(r => expandWeekly(r, rangeStart, rangeEnd));

        // Merge and sort by date/time for cleaner list default
        allEvents = [...oneOff, ...weeklyExpanded]
          .map(e => ({...e, date: normalizeDate(e.date)}))
          .filter(e => e.date); // safety

        buildCategoryChips();

        // Build calendar bounds from merged dates
        const dates = Array.from(new Set(allEvents.map(r=>r.date))).sort();
        if(dates.length){
          datePicker.min = dates[0];
          datePicker.max = dates[dates.length-1];
          const todayStr = isoLocal(new Date());
          datePicker.value = dates.includes(todayStr) ? todayStr : dates[0];
        } else {
          const t = isoLocal(new Date());
          datePicker.min = t; datePicker.max = t; datePicker.value = t;
        }
        render();
      } catch(err){
        console.error('CSV load error', err);
        alert('Could not load one or both CSVs. Please make sure both sheets are published to the web as CSV.');
      }
    }

    function render(){
      const q = (searchEl.value||'').trim().toLowerCase();
      const chosenDate = datePicker.value;
      const filtered = allEvents.filter(e => {
        const matchDate = chosenDate ? e.date === chosenDate : true;
        const matchCat = activeCats.has((e.category || 'Other').trim());
        const hay = `${e.name} ${e.venue} ${e.address}`.toLowerCase();
        const matchText = !q || hay.includes(q);
        return matchDate && matchCat && matchText;
      });

      markersLayer.clearLayers();
      const pts = [];
      filtered.forEach((e,i) => {
        if(Number.isFinite(e.lat) && Number.isFinite(e.lng)){
          const color = CATEGORY_COLORS[e.category] || '#888';
          const marker = L.circleMarker([e.lat, e.lng], {
            radius: 8, weight:2, color: color, fillColor: color, fillOpacity:0.2
          }).addTo(markersLayer);
          marker.bindPopup(
            `<strong>${safe(e.name)}</strong><br>${safe(e.venue||'')}${e.time?` • ${safe(e.time)}`:''}<br>${safe(e.date)}<br><a href="${e.link}" target="_blank" rel="noopener">Event page</a>`
          );
          marker.on('click', () => {
  if (isMobile()) {
    setPinned(e);        // show pinned card on phones
  } else {
    highlightCard(i);    // keep existing behavior on desktop
  }
});

          pts.push([e.lat,e.lng]);
        }
      });
      if(pts.length){ map.fitBounds(pts, {padding:[30,30]}); }

      listEl.innerHTML='';
      filtered.forEach((e,i) => {
        const row = document.createElement('div');
        row.className='item';
        row.onclick = () => {
          if(Number.isFinite(e.lat) && Number.isFinite(e.lng)){
            map.flyTo([e.lat, e.lng], 15, {duration:0.6});
          }
        };

        
        // --- build one list row ---
const color = CATEGORY_COLORS[e.category] || '#888';

const stripe = document.createElement('div');
stripe.className = 'leftStripe';
stripe.style.background = color;
stripe.style.gridRow = '1 / span 2';
stripe.style.alignSelf = 'stretch';

const img = document.createElement('img');
img.className = 'thumb';
img.src = e.photo || 'https://placehold.co/200x200?text=Photo';
img.alt = e.name || 'event photo';

const meta = document.createElement('div');
meta.className = 'meta';

// Mobile: title + badge on one line; Desktop: original layout
if (typeof isMobile === 'function' ? isMobile() : window.matchMedia('(max-width: 960px)').matches) {
  meta.innerHTML = `
    <div class="titleRow">
      <div class="title">${safe(e.name)}</div>
      <span class="badge"><span class="dot" style="background:${color}"></span>${safe(e.category||'')}</span>
    </div>
    <div class="sub">${safe(e.venue || e.address || '')}</div>
    <div class="sub">${safe(e.date)} ${e.time?`• ${safe(e.time)}`:''}</div>
    <div class="sub"><a href="${e.link}" target="_blank" rel="noopener">Event page</a></div>
  `;
} else {
  meta.innerHTML = `
    <div class="title">${safe(e.name)}</div>
    <div class="sub">${safe(e.venue || e.address || '')}</div>
    <div class="sub">${safe(e.date)} ${e.time?`• ${safe(e.time)}`:''}</div>
    <div class="sub"><a href="${e.link}" target="_blank" rel="noopener">Event page</a></div>
    <div><span class="badge"><span class="dot" style="background:${color}"></span>${safe(e.category||'')}</span></div>
  `;
}

// Order content: on phones -> text left, image right; desktop -> image left, text right
const thumbWrap = document.createElement('div');
thumbWrap.appendChild(img);

const rowWrap = document.createElement('div');
rowWrap.style.display = 'contents';

if (typeof isMobile === 'function' ? isMobile() : window.matchMedia('(max-width: 960px)').matches) {
  rowWrap.appendChild(meta);
  rowWrap.appendChild(thumbWrap);
} else {
  rowWrap.appendChild(thumbWrap);
  rowWrap.appendChild(meta);
}

row.appendChild(stripe);
row.appendChild(rowWrap);
listEl.appendChild(row);

      });
      countEl.textContent = `${filtered.length} event${filtered.length===1?'':'s'} shown`;
    }

    function highlightCard(index){
  const cards = [...document.querySelectorAll('.item')];
  const el = cards[index];
  if(!el) return;

  // Smoothly scroll inside the list container only
  const parent = listEl; // #eventsList
  const target = el.offsetTop - (parent.clientHeight / 2) + (el.clientHeight / 2);
  parent.scrollTo({ top: Math.max(0, target), behavior: 'smooth' });

  // Pulse highlight so it stands out
  el.animate([{ background: '#0b1320' }, { background: 'transparent' }], { duration: 900 });
}

    function safe(s){ return (s||'').toString().replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    datePicker.addEventListener('change', render);
    searchEl.addEventListener('input', () => { window.clearTimeout(window.__t); window.__t=setTimeout(render,200); });

    loadAll();
  </script>
</body>
</html>
